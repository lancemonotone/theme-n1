<?php
/**
 * 
 * MemberMouse(TM) (http://www.membermouse.com)
 * (c) MemberMouse, LLC. All rights reserved.
 * 
 * MM_Install handles all install/update related tasks. The master schema is located in data/install_sql.php. 
 * Key things to remember when working with the master schema: 
 * 1. The wordpress dbdelta function is used to keep the schema in sync across versions. 
 *    Formatting is very important, please reference the initial schema when adding new tables
 * 2. PRIMARY KEYs need to be declared on a separate line (vs inline with the column definition. Two spaces need to
 *    follow the words PRIMARY KEY and the definition of that key, otherwise the dbdelta will fail
 * 3. FOREIGN KEYs are not currently supported and can potentially cause dbdeltas to fail.
 * 4. Each column or key definition needs to be on its own line. Lines are delimited by \n (unix-style newline)
 * 5. dbdelta() currently doesn't properly deal with backticks surrounding the column name in KEY definitions
 * 6. dbdelta() will add columns to existing tables, but will not drop removed columns. Those operations will need to be done manually 
 * 
 * With a properly formatted schema, the database structure will be synced to the schema on both install and update, eliminating the need for
 * version-specific update code and different code for installs vs updates. Default data with specified keys (either primary keys or unique column values) 
 * is inserted using INSERT IGNORE sql statements. This handles both insert and update scenarios because duplicate key errors are ignored if the data already exists.
 * 
 */
require_once(ABSPATH.'wp-admin/includes/upgrade.php');

 class MM_Install
 {
 	function __construct()
 	{
 		//default constructor
 	}
 	
 	public function activate()
 	{
 		global $wpdb;
 		ob_start();
 		
 		$error = "";
 		
	 	if($this->createDBCache())
	 	{
	 		if($this->updateMemberMouseClass())
	 		{
	 			// reset minor version if this is a major version upgrade
	 			$crntMajorVersion = MemberMouse::getPluginVersion();
	 			$lastMajorVersion = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_MAJOR_VERSION);
	 			if (!empty($lastMajorVersion) && (version_compare($lastMajorVersion, $crntMajorVersion) < 0))
	 			{	
	 				MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_MINOR_VERSION, MM_MemberMouseService::$DEFAULT_MINOR_VERSION); 
	 			}
	 			
		 		if($this->authenticateWithMM() !== false)
		 		{
		 			if($this->alterMMTables())
		 			{
		 				//628 patch
		 				if (method_exists('MM_MemberMouseService','regulateSchedulingEntries'))
						{
							MM_MemberMouseService::regulateSchedulingEntries();
						}
		 				
		 				if($this->insertMMDefaultData())
		 				{
		 				    //if possible, set path to wp-load.php for use in standalone scripts
		 				    $wplFile = ABSPATH."/wp-load.php";
		 				    $bbFile = dirname(__FILE__)."/../bootstrap/barebones.php";
		 				    if (file_exists($wplFile) && is_writable($bbFile))
		 				    {
		 				        $contents = file_get_contents($bbFile);
		 				        $updatedPath = "/* BEGIN WP-LOAD PATH */\n".
		 			 				           "\$wpload_path = '{$wplFile}';\n".
		 			 				           "/* END WP-LOAD PATH */";
		 				        $contents = preg_replace("/\/\* BEGIN WP-LOAD PATH \*\/\s.*\s\/\* END WP-LOAD PATH \*\//", $updatedPath, $contents);
		 				        file_put_contents($bbFile, $contents);
		 				    }
		 				    
		 					// set new major version
		 					$crntMajorVersion = MemberMouse::getPluginVersion();
		 					MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_MAJOR_VERSION, $crntMajorVersion);
		 					
		 					//update version history
		 					$versionDescription = $crntMajorVersion;
		 					$minorVersion = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_MINOR_VERSION);
		 					
		 					if($minorVersion !== false && intval($minorVersion) > 0)
		 					{
		 						$versionDescription .= "-".$minorVersion;
		 					}
		 					else
		 					{
		 						$versionDescription .= "-".MM_MemberMouseService::$DEFAULT_MINOR_VERSION;
		 					}
		 					
 							$versionRelease = MM_VersionRelease::findByVersion($versionDescription);
 							$versionRelease->setVersion($versionDescription);
 							$versionRelease->commitData();
 							
 							MM_MemberMouseService::activatePlugin();
 							 
 							// clear major version notice
 							$crntMajorVersion = MemberMouse::getPluginVersion();
 							$upgradeVersion = MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_UPGRADE_NOTICE);
 							if(!empty($upgradeVersion) && (version_compare($crntMajorVersion, $upgradeVersion, ">=")))
 							{
 								MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_UPGRADE_NOTICE, "");
 							}
 							
 							ob_end_clean();
	 						return true;	
		 				}
				 		else 
				 		{
	 						$error = "The MemberMouse installer could not install default data into the database. Verify that the permissions of the database user defined in wp-config.php has all privileges.";
				 		}
		 			}
			 		else 
			 		{
	 					$error = "The MemberMouse installer was unable to alter MemberMouse tables. Verify that the permissions of the database user defined in wp-config.php has all privileges.";
			 		}
		 		}
		 		else 
		 		{
		 			$error = "<div style='font-family: sans-serif; font-size: 13px;'>";
		 			
		 			$error .= "<h3 style='color:#BC0B0B; margin-top:0px; margin-bottom:5px; font-size: 14px;'>This site is not authorized to use the MemberMouse plugin</h3>";
		 			
		 			$error .= "<p style='margin-top:0px; margin-bottom:5px;'>This article offers guidance for how to address this. <a href=\"https://support.membermouse.com/support/solutions/articles/9000196842-installation-or-activation-error-fatal-error-site-is-not-registered-to-use-membermouse\" target=\_blank\">Get Help with Plugin Activation</a>.</p>";
		 			
		 			$error .= "</div>";
		 		}
	 		}
	 		else 
	 		{
	 			$error = "Unable to insert MM_MemberMouseService into mm_container table. Verify that the permissions of the database user defined in wp-config.php has all privileges.";
	 		}
	 		
		}
		else 
		{
			$error = "Unable to install the mm_container table. Verify that the permissions of the database user defined in wp-config.php has all privileges.";
		}
 		
	 	ob_end_clean();
	 	
 		// an error occurred so deactivate the plugin
		$this->showError($error);
		exit;
 	}
 	
 	
 	private function showError($error)
 	{
		echo $error; 
		@deactivate_plugins(MM_PLUGIN_ABSPATH."/index.php", false);
 	}
 	
 	
 	private function createDBCache()
 	{
 		global $wpdb;
 		
 		try 
     	{
     		$createSql = "CREATE TABLE IF NOT EXISTS ".MM_TABLE_CONTAINER." (
                id int(11) NOT NULL AUTO_INCREMENT,
     	        name varchar(191) NOT NULL,
     	        obj mediumtext NOT NULL,
     	        is_system tinyint(4) NOT NULL DEFAULT '0',
     	        date_added datetime NOT NULL,
     	        PRIMARY KEY  (id),
     	        KEY name (name)) DEFAULT CHARACTER SET utf8 COLLATE utf8_unicode_ci;";
     	    
     		// create mm_container table if it doesn't exist
     	    $createResult = $wpdb->query($createSql);
     	    if ($createResult !== false)
     	    {
     	        $selectResult = $wpdb->get_results("SELECT * FROM ".MM_TABLE_CONTAINER);
     	        if (count($selectResult) > 0)
     	        {
     	            // delete all rows from mm_container
     	            $wpdb->query("DELETE FROM ".MM_TABLE_CONTAINER);
     	            $secondSelectResult = $wpdb->get_results("SELECT * FROM ".MM_TABLE_CONTAINER);
     	            if (is_array($secondSelectResult) && (count($secondSelectResult) === 0))
     	            {
     	                return true;
     	            }
     	            else
     	            {
     	                // unable to delete rows from mm_container
     	                return false;
     	            }
     	        }
     	    }
     	    else
     	    {
     	        // unable to create mm_container
     	        return false;
     	    }
 		}
 		catch(Exception $e)
 		{
 		    return false;
 		}
		
		return true;
 	}
 	
 	public function updateMemberMouseClass()
 	{
 		global $wpdb;
 		
 		$removeSql = "DELETE FROM ".MM_TABLE_CONTAINER." WHERE name='membermouseservice'";
		$row = $wpdb->get_row($removeSql);
		$wpdb->query($removeSql);
		
		$addSql = "INSERT INTO ".MM_TABLE_CONTAINER." (name, obj, is_system, date_added) values ('membermouseservice', 'Ci8qKgogKiAKICogTWVtYmVyTW91c2UoVE0pIChodHRwOi8vd3d3Lm1lbWJlcm1vdXNlLmNvbSkKICogKGMpIE1lbWJlck1vdXNlLCBMTEMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCiAqLwpjbGFzcyBNTV9NZW1iZXJNb3VzZVNlcnZpY2UKewoJcHVibGljIHN0YXRpYyAkU0VSVkVSSVAgPSBNTV9DRU5UUkFMX1NFUlZFUjsgCgoJcHJpdmF0ZSBzdGF0aWMgJENIRUNLSU5fRkFJTF9NQVhfQ09VTlQgPSAxMDsKCXByaXZhdGUgc3RhdGljICRDSEVDS0lOX0lOVEVSVkFMID0gNDsKCXByaXZhdGUgc3RhdGljICRDSEVDS0lOX1dBUk5JTkdfVEhSRVNIT0xEID0gNzsKCXB1YmxpYyBzdGF0aWMgJERFRkFVTFRfTUlOT1JfVkVSU0lPTiA9ICIxMDAiOwoJCglwdWJsaWMgc3RhdGljICRVU0FHRV9QQUlEX01FTUJFUlMgPSAidXNhZ2VfcGFpZF9tZW1iZXJzIjsKCXB1YmxpYyBzdGF0aWMgJFVTQUdFX0ZSRUVfTUVNQkVSUyA9ICJ1c2FnZV9mcmVlX21lbWJlcnMiOwoJcHVibGljIHN0YXRpYyAkVVNBR0VfUEFJRF9CVU5ETEVTID0gInVzYWdlX3BhaWRfYnVuZGxlcyI7CglwdWJsaWMgc3RhdGljICRVU0FHRV9GUkVFX0JVTkRMRVMgPSAidXNhZ2VfZnJlZV9idW5kbGVzIjsKCXB1YmxpYyBzdGF0aWMgJFVTQUdFX09SREVSUyA9ICJ1c2FnZV9vcmRlcnMiOwoJcHVibGljIHN0YXRpYyAkQ09ORklHX1BBWU1FTlRfTUVUSE9EUyA9ICJjb25maWdfcGF5bWVudF9tZXRob2RzIjsKCXB1YmxpYyBzdGF0aWMgJENPTkZJR19NRU1CRVJTSElQU19GUkVFID0gImNvbmZpZ19mcmVlX21lbWJlcnNoaXBzIjsKCXB1YmxpYyBzdGF0aWMgJENPTkZJR19NRU1CRVJTSElQU19QQUlEID0gImNvbmZpZ19wYWlkX21lbWJlcnNoaXBzIjsKCXB1YmxpYyBzdGF0aWMgJENPTkZJR19CVU5ETEVTX0ZSRUUgPSAiY29uZmlnX2ZyZWVfYnVuZGxlcyI7CglwdWJsaWMgc3RhdGljICRDT05GSUdfQlVORExFU19QQUlEID0gImNvbmZpZ19wYWlkX2J1bmRsZXMiOwoJcHVibGljIHN0YXRpYyAkQ09ORklHX1BST0RVQ1RTID0gImNvbmZpZ19wcm9kdWN0cyI7CglwdWJsaWMgc3RhdGljICRDT05GSUdfREVGQVVMVF9FTVBMT1lFRV9FTUFJTCA9ICJjb25maWdfZGZsdF9lbXBsb3llZV9lbWFpbCI7CglwdWJsaWMgc3RhdGljICRDT05GSUdfREVGQVVMVF9FTVBMT1lFRV9OQU1FID0gImNvbmZpZ19kZmx0X2VtcGxveWVlX25hbWUiOwoJcHVibGljIHN0YXRpYyAkQ09ORklHX0NVUlJFTkNZID0gImNvbmZpZ19jdXJyZW5jeSI7CgkKCXB1YmxpYyBzdGF0aWMgJFBST1BTX1dQX1ZFUlNJT04gPSAid3BfdmVyc2lvbiI7CglwdWJsaWMgc3RhdGljICRQUk9QU19QSFBfVkVSU0lPTiA9ICJwaHBfdmVyc2lvbiI7CglwdWJsaWMgc3RhdGljICRQUk9QU19NTV9CRVRBID0gIm1tX2JldGEiOwoJCglwdWJsaWMgc3RhdGljICRNRVRIT0RfQVVUSE9SSVpFID0gImF1dGhvcml6ZVBsdWdpbiI7CglwdWJsaWMgc3RhdGljICRNRVRIT0RfQUNUSVZBVEUgPSAiYWN0aXZhdGVQbHVnaW4iOwoJcHVibGljIHN0YXRpYyAkTUVUSE9EX0RFQUNUSVZBVEUgPSAiZGVhY3RpdmF0ZVBsdWdpbiI7CglwdWJsaWMgc3RhdGljICRNRVRIT0RfUkVQT1JUX1NDSEVEVUxFX1NUQVRFID0gInJlcG9ydFNjaGVkdWxlU3RhdGUiOwoJCglwdWJsaWMgc3RhdGljICRPUFRJT05fS0VZX0NIRUNLSU5fRkFJTEVEX0NPVU5UID0gIm1tLW9wdGlvbi1mYWlsZWQtY2hlY2tpbi1jb3VudCI7Cglwcml2YXRlIHN0YXRpYyAkQ0FDSEVEX0xJQ0VOU0VfT0JKID0gbnVsbDsKCXByaXZhdGUgc3RhdGljICRDQUNIRURfTElDRU5TRV9WQUxJREFURUQgPSBmYWxzZTsKCXByaXZhdGUgc3RhdGljICRBVVRIX0xPQ0sgPSBmYWxzZTsKCXByaXZhdGUgc3RhdGljICRBVVRIX0xPQ0tfSURFTlRJRklFUiA9ICJtbS1hdXRob3JpemF0aW9uLWxvY2siOwoKCQoJLyoqCgkgKiBEZXRlcm1pbmVzIGlmIHRoZSBwbHVnaW4gc2hvdWxkIGF1dGhvcml6ZSB3aXRoIE1NIGNlbnRyYWwKCSAqLwoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gZG9BdXRob3JpemUoKQoJewoJCSRsb2NrU3RhdHVzID0gc2VsZjo6YWNxdWlyZVNlbWFwaG9yZSgpOwoJCWlmICgkbG9ja1N0YXR1cyA9PT0gMCkKCQl7CgkJCXJldHVybiBmYWxzZTsKCQl9CgoJCWlmKCFwcmVnX21hdGNoKCIvKHBsdWdpbnNcLnBocCkvIiwgJF9TRVJWRVJbIlBIUF9TRUxGIl0pKQoJCXsKCQkJJGxhc3RDaGVja2luID0gYmFzZTY0X2RlY29kZShNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MQVNUX0NIRUNLSU4pKTsKCQkJJG5leHRDaGVjayA9IHN0cnRvdGltZSgiKyIuc2VsZjo6JENIRUNLSU5fSU5URVJWQUwuIiBkYXkiLCBzdHJ0b3RpbWUoJGxhc3RDaGVja2luKSk7CgkJCSR0b2RheSA9IGRhdGUoIlktbS1kIGg6aTpzIik7IAoJCQlpZihzdHJ0b3RpbWUoJHRvZGF5KSA+PSAkbmV4dENoZWNrKQoJCQl7IAoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX0gCgkJcmV0dXJuIGZhbHNlOwoJfQoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBoYXNTdXJwYXNzZWRGYWlsZWRUaHJlc2hvbGRNYXgoKQoJewoJCSRjbnQgPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKHNlbGY6OiRPUFRJT05fS0VZX0NIRUNLSU5fRkFJTEVEX0NPVU5UKTsKCQlpZihpc19udWxsKCRjbnQpIHx8IGVtcHR5KCRjbnQpKQoJCXsKCQkJJGNudCA9IDA7CgkJfQoJCWlmKCRjbnQ+PXNlbGY6OiRDSEVDS0lOX0ZBSUxfTUFYX0NPVU5UKQoJCXsgCgkJCXJldHVybiB0cnVlOwoJCX0gCgkJcmV0dXJuIGZhbHNlOwoJfQoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiB1cGRhdGVGYWlsZWRSZXF1ZXN0Q291bnQoKQoJewoJICAgIGdsb2JhbCAkd3BkYjsKCSAgICAKCSAgICBpZiAoIWlzX29iamVjdCgkd3BkYikpCgkgICAgewoJICAgICAgICByZXR1cm47IC8vZXJyb3IKCSAgICB9CgkgICAgCgkgICAgLy9hY3F1aXJlIHNlbWFwaG9yZQoJICAgICRpbnRlcm5hbExvY2tJRCA9ICJtbS1zZXJ2aWNlLWZhaWx1cmUtY2hlY2staW50ZXJuYWwiOwoJICAgICRsb2NrQWNxdWlyZWQgPSAkd3BkYi0+Z2V0X3Zhcigkd3BkYi0+cHJlcGFyZSgiU0VMRUNUIElGKElTX0ZSRUVfTE9DSyglcyksQ09BTEVTQ0UoR0VUX0xPQ0soJXMsMCksLTEpLDApIiwkaW50ZXJuYWxMb2NrSUQsJGludGVybmFsTG9ja0lEKSk7CgkgICAgaWYgKCRsb2NrQWNxdWlyZWQgPT0gIjEiKQoJICAgIHsgICAgCiAgICAgICAgCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MQVNUX0NIRUNLSU4sIGJhc2U2NF9lbmNvZGUoZGF0ZSgiWS1tLWQgaDppOnMiKSkpOwogICAgICAgIAkJJGNudCA9IE1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oc2VsZjo6JE9QVElPTl9LRVlfQ0hFQ0tJTl9GQUlMRURfQ09VTlQpOwogICAgICAgIAkJaWYoZW1wdHkoJGNudCkgfHwgIWlzX251bWVyaWMoJGNudCkpCiAgICAgICAgCQl7CiAgICAgICAgCQkJJGNudCA9IDA7CiAgICAgICAgCQl9CiAgICAgICAgCQkkY250Kys7CiAgICAgICAgCQkJCiAgICAgICAgCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKHNlbGY6OiRPUFRJT05fS0VZX0NIRUNLSU5fRkFJTEVEX0NPVU5ULCAkY250KTsKICAgICAgICAJCWlmICgkY250ID4gc2VsZjo6JENIRUNLSU5fV0FSTklOR19USFJFU0hPTEQpCiAgICAgICAgCQl7CiAgICAgICAgCQkJc2VsZjo6c2VuZFdhcm5pbmdFbWFpbCgpOwogICAgICAgIAkJfQogICAgICAgIAkJLy9yZWxlYXNlIHNlbWFwaG9yZQogICAgICAgIAkJJHdwZGItPnF1ZXJ5KCR3cGRiLT5wcmVwYXJlKCJTRUxFQ1QgUkVMRUFTRV9MT0NLKCVzKSIsJGludGVybmFsTG9ja0lEKSk7CgkgICAgfQoJfSAgCgoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBhdXRob3JpemUoJHJlZnJlc2hDbGFzc2VzPXRydWUsICRzaXRlVXJsPW51bGwpCgl7IAoJCWlmKCFzZWxmOjpfYXV0aG9yaXplKCRyZWZyZXNoQ2xhc3NlcykpCgkJewoJCQlpZihmdW5jdGlvbl9leGlzdHMoImdldF9vcHRpb24iKSkKCQkJeyAKCQkJCSRleGlzdGluZ1NpdGVVcmwgPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKCJzaXRldXJsIik7CgkJCQkkc2l0ZVVybCA9IGdldF9vcHRpb24oInNpdGV1cmwiLGZhbHNlKTsKCgkJCQlpZigkc2l0ZVVybCA9PT0gZmFsc2UgfHwgJGV4aXN0aW5nU2l0ZVVybCA9PSAkc2l0ZVVybCkKCQkJCXsgCgkJCQkJcmV0dXJuIGZhbHNlOwoJCQkJfSAKCQkJCXJldHVybiBzZWxmOjpfYXV0aG9yaXplKCRyZWZyZXNoQ2xhc3NlcywgJHNpdGVVcmwpOwoJCQl9ICAKCQkJcmV0dXJuIGZhbHNlOwoJCX0gCgkJcmV0dXJuIHRydWU7Cgl9CgoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBfYXV0aG9yaXplKCRyZWZyZXNoQ2xhc3Nlcz10cnVlLCAkc2l0ZVVybD1udWxsKQoJewoJCWlmICgkcmVmcmVzaENsYXNzZXMpCgkJewoJCQkvL2NsYXNzIHJlZnJlc2ggcmVxdWVzdHMgbWVhbnMgdGhlIGNhbGwgaXMgY29taW5nIGZyb20gZXh0ZXJuYWwsIGF0dGVtcHQgdG8gYWNxdWlyZSB0aGUgc2VtYXBob3JlCgkJCWlmICgoc2VsZjo6JEFVVEhfTE9DSyA9PT0gZmFsc2UpICAmJiAoc2VsZjo6YWNxdWlyZVNlbWFwaG9yZSgpID09PSAwKSkKCQkJewoJCQkJcmV0dXJuIHRydWU7CgkJCX0KCQl9IAoJCSR1cmwgPSAoZW1wdHkoJHNpdGVVcmwpIHx8IGlzX251bGwoJHNpdGVVcmwpKT8gTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbigic2l0ZXVybCIpOiRzaXRlVXJsOyAKCQkkdmVyc2lvbiA9IE1lbWJlck1vdXNlOjpnZXRQbHVnaW5WZXJzaW9uKCk7CgkJJHBvc3R2YXJzID0gInVybD0iLnVybGVuY29kZSgkdXJsKS4iJnZlcnNpb249Ii4kdmVyc2lvbjsKCQkkbWlub3JWZXJzaW9uID0gTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTUlOT1JfVkVSU0lPTik7CgoJCWlmKCRtaW5vclZlcnNpb24gIT09IGZhbHNlICYmIGludHZhbCgkbWlub3JWZXJzaW9uKSA+IDApCgkJewoJCQkkcG9zdHZhcnMgLj0gIiZtaW5vcl92ZXJzaW9uPSIuJG1pbm9yVmVyc2lvbjsKCQl9CgkJZWxzZSAKCQl7CgkJCSRwb3N0dmFycyAuPSAiJm1pbm9yX3ZlcnNpb249Ii5zZWxmOjokREVGQVVMVF9NSU5PUl9WRVJTSU9OOwoJCX0KCQkKCQlpZihjbGFzc19leGlzdHMoIk1NX0FwcGxpZWRCdW5kbGUiKSkKCQl7CgkJCSRwb3N0dmFycyAuPSAiJnN0YXRpc3RpY3M9Ii51cmxlbmNvZGUoanNvbl9lbmNvZGUoTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjpnZW5lcmF0ZVN0YXRpc3RpY3MoKSkpOwoJCX0KCQkKCQkkcG9zdHZhcnMgLj0gIiZwcm9wZXJ0aWVzPSIudXJsZW5jb2RlKGpzb25fZW5jb2RlKE1NX01lbWJlck1vdXNlU2VydmljZTo6Z2VuZXJhdGVQcm9wZXJ0aWVzKCkpKTsKCQkKCQkkcG9zdHZhcnMgLj0gIiZnZXRfY2xhc3Nlcz0iLigkcmVmcmVzaENsYXNzZXMgPyAiMSIgOiAiMCIpOwoKCQkkanNvbl9kYXRhID0gc2VsZjo6c2VuZFJlcXVlc3Qoc2VsZjo6JE1FVEhPRF9BVVRIT1JJWkUsICRwb3N0dmFycyk7CgoJCWlmKCRqc29uX2RhdGEgPT09IGZhbHNlKQoJCXsgIAoJCQlzZWxmOjp1cGRhdGVGYWlsZWRSZXF1ZXN0Q291bnQoKTsKCQkJaWYgKHNlbGY6Omhhc1N1cnBhc3NlZEZhaWxlZFRocmVzaG9sZE1heCgpKQoJCQl7CgkJCQlpZihNTV9VdGlsczo6aXNNZW1iZXJNb3VzZUFjdGl2ZSgpKQoJCQkJewoJCQkJICAgIE1NX0RpYWdub3N0aWNMb2c6OmxvZyhNTV9EaWFnbm9zdGljTG9nOjokTU1fRVJST1IsImluaXRpYXRlIHBsdWdpbiBkZWFjdGl2YXRpb24gZnJvbSBhdXRob3JpemUoKSBkdWUgdG8gc3VycGFzc2VkIGZhaWxlZCB0aHJlc2hvbGQgbWF4Iik7CgkJCQkJc2VsZjo6aW5pdGlhdGVQbHVnaW5EZWFjdGl2YXRpb24oKTsKCQkJCX0KCQkJfQoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJCWVsc2UgaWYoc2VsZjo6aXNVbmF1dGhvcml6ZWRSZXN1bHQoJGpzb25fZGF0YSkpCgkJewoJCQlpZihNTV9VdGlsczo6aXNNZW1iZXJNb3VzZUFjdGl2ZSgpKQoJCQl7CgkJCSAgICBNTV9EaWFnbm9zdGljTG9nOjpsb2coTU1fRGlhZ25vc3RpY0xvZzo6JE1NX0VSUk9SLCJpbml0aWF0ZSBwbHVnaW4gZGVhY3RpdmF0aW9uIGZyb20gYXV0aG9yaXplKCkgZHVlIHRvIHVuYXV0aG9yaXplZCByZXN1bHQiKTsKCQkJCXNlbGY6OmluaXRpYXRlUGx1Z2luRGVhY3RpdmF0aW9uKCk7CgkJCX0KCQkJcmV0dXJuIGZhbHNlOwoJCX0KCgkJTU1fT3B0aW9uVXRpbHM6OnNldE9wdGlvbihzZWxmOjokT1BUSU9OX0tFWV9DSEVDS0lOX0ZBSUxFRF9DT1VOVCwgMCk7CgkJJGpzb24gPSAkanNvbl9kYXRhLT5yZXNwb25zZV9kYXRhOwoJCQoJCWlmICgkcmVmcmVzaENsYXNzZXMgJiYgc2VsZjo6JEFVVEhfTE9DSykKCQl7CgkJCXNlbGY6OnJlbGVhc2VTZW1hcGhvcmUoKTsKCQl9CgkJcmV0dXJuIHNlbGY6OnVwZGF0ZUxpY2Vuc2VEYXRhKCRqc29uKTsKCX0KCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBhY3RpdmF0ZVBsdWdpbigpCgl7CgkJJHBvc3R2YXJzID0gInVybD0iLk1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oInNpdGV1cmwiKTsKCQlzZWxmOjpzZW5kUmVxdWVzdChzZWxmOjokTUVUSE9EX0FDVElWQVRFLCAkcG9zdHZhcnMpOwoJfQoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGRlYWN0aXZhdGVQbHVnaW4oKQoJewoJCWdsb2JhbCAkd3BkYjsKCQkKCQkvLyBjbGVhciBsaWNlbnNlIGRhdGEKCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MSUNFTlNFX0RBVEEsICIiKTsKCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MQVNUX0NIRUNLSU4sICIiKTsKCQkKCQkkcG9zdHZhcnMgPSAidXJsPSIuTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbigic2l0ZXVybCIpOwoJCXNlbGY6OnNlbmRSZXF1ZXN0KHNlbGY6OiRNRVRIT0RfREVBQ1RJVkFURSwgJHBvc3R2YXJzKTsKCQkKCQkkc3FsID0gIkRFTEVURSBGUk9NICIuTU1fVEFCTEVfQ09OVEFJTkVSOwoJCSR3cGRiLT5xdWVyeSgkc3FsKTsKCX0KCQoJLyoqCgkgKiBUaGlzIGZ1bmN0aW9uIGZvcmNlcyBhIGNoZWNraW4KCSAqLwoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBwaW5nKCkKCXsKCQkvLyBjaGVjayBpZiBNZW1iZXJNb3VzZSBwbHVnaW4gaXMgYWN0aXZlCgkJaWYoIU1NX1V0aWxzOjppc01lbWJlck1vdXNlQWN0aXZlKCkpCgkJewoJCQlyZXR1cm4gbmV3IE1NX1Jlc3BvbnNlKCJNZW1iZXJNb3VzZSBwbHVnaW4gaXMgY3VycmVudGx5IGRlYWN0aXZhdGVkIiwgTU1fUmVzcG9uc2U6OiRFUlJPUik7CgkJfQoJCQoJCXJldHVybiBzZWxmOjphdXRob3JpemUoZmFsc2UpOwoJfQoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiB1cGRhdGVMaWNlbnNlRGF0YSgkanNvbikKCXsKCQlpZihpc3NldCgkanNvbi0+aXNWYWxpZCkpCgkJewoJCQlpZihpc3NldCgkanNvbi0+bGljZW5zZURhdGEpKQoJCQl7IAoJCQkJJGxpY2Vuc2UgPSBuZXcgTU1fTGljZW5zZSgiIiwgZmFsc2UpOwoJCQkJJGxpY2Vuc2UtPnNldERhdGEoJGpzb24tPmxpY2Vuc2VEYXRhKTsKCgkJCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9MQVNUX0NIRUNLSU4sIGJhc2U2NF9lbmNvZGUoZGF0ZSgiWS1tLWQgaDppOnMiKSkpOwoJCQkJTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjpzdG9yZUxpY2Vuc2UoJGxpY2Vuc2UpOwoJCQl9CgkJCQoJCQlpZighZW1wdHkoJGpzb24tPmNsYXNzZXMpKQoJCQl7CQoJCQkJc2VsZjo6c2F2ZUR5bmFtaWNDbGFzc2VzKCRqc29uLT5jbGFzc2VzKTsKCQkJfQoJCQkKCQkJaWYoIWVtcHR5KCRqc29uLT5ub3RpZmljYXRpb25zKSAmJiBpc19hcnJheSgkanNvbi0+bm90aWZpY2F0aW9ucykpCgkJCXsKCQkJCWZvcmVhY2goJGpzb24tPm5vdGlmaWNhdGlvbnMgYXMgJG5vdGlmaWNhdGlvbikKCQkJCXsKCQkJCQlzd2l0Y2goJG5vdGlmaWNhdGlvbi0+dHlwZSkKCQkJCQl7CgkJCQkJCWNhc2UgIm1ham9yLXZlcnNpb24tdXBncmFkZSI6CgkJCQkJCQlNTV9PcHRpb25VdGlsczo6c2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9VUEdSQURFX05PVElDRSwgJG5vdGlmaWNhdGlvbi0+dmFsdWUpOwoJCQkJCQkJYnJlYWs7CgkJCQkJCQkKCQkJCQkJY2FzZSAibWlub3ItdmVyc2lvbi11cGdyYWRlIjoKICAgICAgICAJCQkJCU1NX09wdGlvblV0aWxzOjpzZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX01JTk9SX1ZFUlNJT04sICRub3RpZmljYXRpb24tPnZhbHVlKTsKCQkJCQkJCWJyZWFrOwoJCQkJCX0KCQkJCX0KCgkJCQkvLy8vLy8gdXBkYXRlIG5ldyB2ZXJzaW9uIGlmIG9uZSBleGlzdHMuCgkJCQlpZihpc3NldCgkanNvbi0+bGljZW5zZURhdGEpICYmIGlzc2V0KCRqc29uLT5saWNlbnNlRGF0YS0+bWFqb3JWZXJzaW9uKSAmJiBpc3NldCgkanNvbi0+bGljZW5zZURhdGEtPm1pbm9yVmVyc2lvbikpCgkJCQl7CgkJCQkJJHZlcnNpb25TdHIgPSAkanNvbi0+bGljZW5zZURhdGEtPm1ham9yVmVyc2lvbi4iLSIuJGpzb24tPmxpY2Vuc2VEYXRhLT5taW5vclZlcnNpb247CgkJCQkJJG1tdiA9ICBNTV9WZXJzaW9uUmVsZWFzZTo6ZmluZEJ5VmVyc2lvbigkdmVyc2lvblN0cik7CgkJCQkJaWYoISRtbXYtPmlzVmFsaWQoKSkKCQkJCQl7CgkJCQkJCSRtbXYtPnNldFZlcnNpb24oJHZlcnNpb25TdHIpOwoJCQkJCQkkbW12LT5jb21taXREYXRhKCk7CgkJCQkJfQoJCQkJfQoJCQl9CgkKCQkJcmV0dXJuIHRydWU7CgkJfQoJCgkJcmV0dXJuIGZhbHNlOwoJfQoJCgkKCS8qKiBVVElMSVRJRVMgKiovCgkKCXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIHNhdmVEeW5hbWljQ2xhc3NlcygkY2xhc3NlcykKCXsKCQlnbG9iYWwgJHdwZGI7CgkJCgkJaWYoaXNfb2JqZWN0KCRjbGFzc2VzKSB8fCBpc19hcnJheSgkY2xhc3NlcykpCgkJewoJCQkkc3FsID0gIkRFTEVURSBGUk9NICIuTU1fVEFCTEVfQ09OVEFJTkVSLiIgV0hFUkUgaXNfc3lzdGVtPScwJyI7CgkJCSR3cGRiLT5xdWVyeSgkc3FsKTsKCQkJCgkJCWZvcmVhY2goJGNsYXNzZXMgYXMgJGNsYXNzTmFtZT0+JGNsYXNzRW50cnkpCgkJCXsKCQkJCSRzcWwgPSAiSU5TRVJUIElOVE8gIi5NTV9UQUJMRV9DT05UQUlORVIuIiBTRVQgbmFtZT0nJXMnLCBvYmo9JyVzJywgZGF0ZV9hZGRlZD1OT1coKSI7CgkJCQkKCQkJCWlmKHN0cnRvbG93ZXIoJGNsYXNzTmFtZSkgPT0gIm1lbWJlcm1vdXNlc2VydmljZSIpCgkJCQl7CgkJCQkJJHNxbCA9ICJVUERBVEUgIi5NTV9UQUJMRV9DT05UQUlORVIuIiBTRVQgbmFtZT0nJXMnLCBvYmo9JyVzJywgZGF0ZV9hZGRlZD1OT1coKSB3aGVyZSBuYW1lPSdtZW1iZXJtb3VzZXNlcnZpY2UnIExJTUlUIDEiOwoJCQkJfQoJCQkJCgkJCQlpZigkd3BkYi0+cXVlcnkoJHdwZGItPnByZXBhcmUoJHNxbCwgJGNsYXNzTmFtZSwgJGNsYXNzRW50cnkpKSkKCQkJCXsKCQkJCQkkY2FjaGVSZXN1bHQgPSBzZWxmOjpjYWNoZUNsYXNzKCRjbGFzc05hbWUsICRjbGFzc0VudHJ5KTsKCQkJCX0KCQkJfQoJCQkKCQkJTU1fU2Vzc2lvbjo6dmFsdWUoTU1fU2Vzc2lvbjo6JEtFWV9VU0lOR19EQl9DQUNIRSwgISRjYWNoZVJlc3VsdCk7CgkJfQoJCQoJCXJldHVybiB0cnVlOwoJfQoKCXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIGNhY2hlQ2xhc3MoJGNsYXNzTmFtZSwgJGNsYXNzRW50cnkpCgl7CgkJJGZpbGVQYXRoID0gTU1fUExVR0lOX0FCU1BBVEguIi9jb20vbWVtYmVybW91c2UvY2FjaGUiOwoJCQoJCWlmKGlzX2RpcigkZmlsZVBhdGgpKQoJCXsKCQkJaWYoaXNfd3JpdGVhYmxlKCRmaWxlUGF0aCkpCgkJCXsKCQkJCWlmKHByZWdfbWF0Y2goIi8obWVtYmVybW91c2Vfc2NoZW1hKSQvIiwgJGNsYXNzTmFtZSkpCgkJCQl7CgkJCQkJJGZpbGVQYXRoIC49ICIvIi4kY2xhc3NOYW1lLiIuc3FsIjsKCQkJCX0KCQkJCWVsc2UKCQkJCXsKCQkJCQkkZmlsZVBhdGggLj0gIi8iLmJhc2U2NF9lbmNvZGUoJGNsYXNzTmFtZSkuIi5jYWNoZSI7CgkJCQl9CgkJCQkKCQkJCSRmaCA9IGZvcGVuKCRmaWxlUGF0aCwgJ3cnKTsKCQkJCWZ3cml0ZSgkZmgsICRjbGFzc0VudHJ5KTsKCQkJCWZjbG9zZSgkZmgpOwoJCQkJCgkJCQlpZihmaWxlX2V4aXN0cygkZmlsZVBhdGgpKQoJCQkJewoJCQkJCUBjaG1vZCgkZmlsZVBhdGgsIDA3NDQpOwoJCQkJfQoJCQkJCgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCXJldHVybiBmYWxzZTsKCQkJfQoJCX0KCQllbHNlCgkJewoJCQlyZXR1cm4gZmFsc2U7CgkJfQoJfSAKCQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gc2VuZFJlcXVlc3QoJG1ldGhvZCwgJHBvc3R2YXJzKQoJewoJCSR1cmwgPSBzZWxmOjokU0VSVkVSSVAuJG1ldGhvZDsKCQoJCSRyZXNwb25zZSA9IHdwX3JlbW90ZV9wb3N0KCR1cmwsIGFycmF5KCdtZXRob2QnID0+ICdQT1NUJywKCQkJCQkJCQkJCQkgICAndGltZW91dCcgPT4gNDUsCgkJCQkJCQkJCQkJICAgJ2JvZHknPT4kcG9zdHZhcnMpKTsKCQoJCWlmIChpc193cF9lcnJvcigkcmVzcG9uc2UpIHx8IChpc3NldCgkcmVzcG9uc2VbJ3Jlc3BvbnNlJ10pICYmIGlzc2V0KCRyZXNwb25zZVsncmVzcG9uc2UnXVsnY29kZSddKSAmJiAoJHJlc3BvbnNlWydyZXNwb25zZSddWydjb2RlJ10gIT0gIjIwMCIpKSB8fCAKCQkJCSghaXNzZXQoJHJlc3BvbnNlWydib2R5J10pKSApIAoJCXsgIAoJCQkvLyB1bmFibGUgdG8gY29ubmVjdCB0byBzZXJ2ZXIKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCQllbHNlIAoJCXsKCQkJJGpzb24gPSBqc29uX2RlY29kZSgkcmVzcG9uc2VbJ2JvZHknXSk7IAoJCQlpZighaXNfbnVsbCgkanNvbikgJiYgaXNzZXQoJGpzb24tPnJlc3BvbnNlX2RhdGEpKQoJCQl7CQoJCQkJJG9yaWdSZXNwb25zZSA9ICRqc29uLT5yZXNwb25zZV9kYXRhOwoJCQkJaWYoaXNfc3RyaW5nKCRqc29uLT5yZXNwb25zZV9kYXRhKSkKCQkJCXsKCQkJCQkkanNvbi0+cmVzcG9uc2VfZGF0YSA9IGpzb25fZGVjb2RlKCRqc29uLT5yZXNwb25zZV9kYXRhKTsKCQkJCQkJCgkJCQkJaWYoaXNfbnVsbCgkanNvbi0+cmVzcG9uc2VfZGF0YSkpCgkJCQkJewoJCQkJCQkkanNvbi0+cmVzcG9uc2VfZGF0YSA9ICRvcmlnUmVzcG9uc2U7CgkJCQkJfQoJCQkJfQoJCQkKCQkJCS8vIHZhbGlkYXRlIGxpY2Vuc2UgZGF0YSBmb3IgYXV0aG9yaXphdGlvbnMKCQkJCWlmKCRtZXRob2QgPT0gc2VsZjo6JE1FVEhPRF9BVVRIT1JJWkUgJiYgKCFpc3NldCgkanNvbi0+cmVzcG9uc2VfZGF0YS0+bGljZW5zZURhdGEpIHx8ICFpc3NldCgkanNvbi0+cmVzcG9uc2VfZGF0YS0+bGljZW5zZURhdGEtPmlkKSkpCgkJCQl7CgkJCQkJJGVycm9yID0gbmV3IHN0ZENsYXNzKCk7CgkJCQkJJGVycm9yLT5yZXNwb25zZV9jb2RlID0gIjQwMSI7CgkJCQkJcmV0dXJuICRlcnJvcjsKCQkJCX0JIAoJCQkJcmV0dXJuICRqc29uOwoJCQl9CgkJCWVsc2UgCgkJCXsJIAoJCQkJLy8gbGljZW5zZSBpcyBjYW5jZWxlZAoJCQkJJGVycm9yID0gbmV3IHN0ZENsYXNzKCk7CgkJCQkkZXJyb3ItPnJlc3BvbnNlX2NvZGUgPSAiNDAxIjsKCQkJCXJldHVybiAkZXJyb3I7CgkJCX0KCQl9Cgl9CgkKCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGlzU3VjY2Vzc2Z1bFJlc3VsdCgkcmVzdWx0KQoJeyAKCQlpZighaXNfbnVsbCgkcmVzdWx0KSAmJiAoJHJlc3VsdC0+cmVzcG9uc2VfY29kZSA9PSAiMjAwIikpCgkJewoJCQlyZXR1cm4gdHJ1ZTsKCQl9CgkKCQlyZXR1cm4gZmFsc2U7Cgl9CgkKCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBpc1VuYXV0aG9yaXplZFJlc3VsdCgkcmVzdWx0KQoJewoJCWlmICgoJHJlc3VsdCAhPSBudWxsKSAmJiAoaXNzZXQoJHJlc3VsdC0+cmVzcG9uc2VfY29kZSkpICYmICgkcmVzdWx0LT5yZXNwb25zZV9jb2RlID09ICI0MDEiKSkKCQl7CgkJCXJldHVybiB0cnVlOwoJCX0KCQlyZXR1cm4gZmFsc2U7Cgl9CgkKCQoJLyoqIFNJVEUgU1RBVFMgQU5EIFBST1BFUlRJRVMgKiovCgkKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gZ2VuZXJhdGVTdGF0aXN0aWNzKCkKCXsKCQlnbG9iYWwgJHdwZGI7CgkJCgkJJHN0YXRpc3RpY3MgPSBhcnJheShzZWxmOjokVVNBR0VfUEFJRF9NRU1CRVJTID0+IDAsCgkJCQkJCQlzZWxmOjokVVNBR0VfRlJFRV9NRU1CRVJTID0+IDAsCgkJCQkJCQlzZWxmOjokVVNBR0VfUEFJRF9CVU5ETEVTID0+IDAsCgkJCQkJCQlzZWxmOjokVVNBR0VfRlJFRV9CVU5ETEVTID0+IDAsCgkJCQkJCQlzZWxmOjokVVNBR0VfT1JERVJTID0+IDAsCgkJCQkJCQlzZWxmOjokQ09ORklHX1BBWU1FTlRfTUVUSE9EUyA9PiAiIiwKCQkJCQkJCXNlbGY6OiRDT05GSUdfTUVNQkVSU0hJUFNfUEFJRCA9PiAwLAoJCQkJCQkJc2VsZjo6JENPTkZJR19NRU1CRVJTSElQU19GUkVFID0+IDAsCgkJCQkJCQlzZWxmOjokQ09ORklHX0JVTkRMRVNfUEFJRCA9PiAwLAoJCQkJCQkJc2VsZjo6JENPTkZJR19CVU5ETEVTX0ZSRUUgPT4gMCwKCQkJCQkJCXNlbGY6OiRDT05GSUdfUFJPRFVDVFMgPT4gMCwKCQkJCQkJCXNlbGY6OiRDT05GSUdfREVGQVVMVF9FTVBMT1lFRV9FTUFJTCA9PiAiIiwKCQkJCQkJCXNlbGY6OiRDT05GSUdfREVGQVVMVF9FTVBMT1lFRV9OQU1FICA9PiAiIgkJCQkKCQkpOwoJCQoJCSRjaGVja1RhYmxlc0V4aXN0ID0gJHdwZGItPnF1ZXJ5KCJTSE9XIFRBQkxFUyBMSUtFICciLk1NX1RBQkxFX1VTRVJfREFUQS4iJyIpOwoJCWlmICgkY2hlY2tUYWJsZXNFeGlzdCAhPT0gMCkgLy9pZiB0aGUgdXNlciBkYXRhIHRhYmxlIGRvZXNuJ3QgZXhpc3RzLCB3ZSBhcmUgaW4gdGhlIGluc3RhbGwsIGRvbid0IHRyeSB0byBnYXRoZXIgdGhlIG90aGVyIHN0YXRpc3RpY3MKCQl7CQkKCQkJLy8gUEFJRCBNRU1CRVJTIChVU0FHRSkKCQkJJGJhc2VTcWwgPSAiU0VMRUNUIGNvdW50KHUud3BfdXNlcl9pZCkgYXMgdG90YWwgRlJPTSAiLk1NX1RBQkxFX1VTRVJfREFUQS4iIHUsICIuTU1fVEFCTEVfTUVNQkVSU0hJUF9MRVZFTFMuIiBtIFdIRVJFICI7CgkJCSRiYXNlU3FsIC49ICJ1Lm1lbWJlcnNoaXBfbGV2ZWxfaWQgPSBtLmlkIEFORCAodS5zdGF0dXMgPSAnIi5NTV9TdGF0dXM6OiRBQ1RJVkUuIicgT1IgdS5zdGF0dXMgPSAnIi5NTV9TdGF0dXM6OiRQRU5ESU5HX0NBTkNFTExBVElPTi4iJykgIjsKCQkJCgkJCSRyZXN1bHQgPSAkd3BkYi0+Z2V0X3JvdygkYmFzZVNxbC4iIEFORCBtLmlzX2ZyZWUgIT0gJzEnOyIpOwoJCQkKCQkJaWYoJHJlc3VsdCkKCQkJewoJCQkJJHBhaWRNZW1iZXJzID0gJHJlc3VsdC0+dG90YWw7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkkcGFpZE1lbWJlcnMgPSAwOwoJCQl9CgkJCQoJCQkkc3RhdGlzdGljc1tzZWxmOjokVVNBR0VfUEFJRF9NRU1CRVJTXSA9ICRwYWlkTWVtYmVyczsKCQkJCgkJCS8vIEZSRUUgTUVNQkVSUyAoVVNBR0UpCgkJCSRyZXN1bHQgPSAkd3BkYi0+Z2V0X3JvdygkYmFzZVNxbC4iIEFORCBtLmlzX2ZyZWUgPSAnMSc7Iik7CgkJCQoJCQlpZigkcmVzdWx0KQoJCQl7CgkJCQkkZnJlZU1lbWJlcnMgPSAkcmVzdWx0LT50b3RhbDsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCSRmcmVlTWVtYmVycyA9IDA7CgkJCX0KCQkJCgkJCSRzdGF0aXN0aWNzW3NlbGY6OiRVU0FHRV9GUkVFX01FTUJFUlNdID0gJGZyZWVNZW1iZXJzOwoJCQkKCQkJLy8gUEFJRCBCVU5ETEVTIChVU0FHRSkKCQkJJGJhc2VTcWwgPSAiU0VMRUNUIGNvdW50KDEpIGFzIHRvdGFsX2J1bmRsZXMgRlJPTSAiLk1NX1RBQkxFX0FQUExJRURfQlVORExFUy4iIGFwcEJ1bmRsZXMsIHskd3BkYi0+dXNlcnN9IHVzZXJzLCAiOwoJCQkkYmFzZVNxbCAuPSBNTV9UQUJMRV9CVU5ETEVTLiIgYnVuZGxlcyBXSEVSRSBhcHBCdW5kbGVzLmFjY2Vzc190eXBlPSciLk1NX0FwcGxpZWRCdW5kbGU6OiRBQ0NFU1NfVFlQRV9VU0VSLiInIEFORCBhcHBCdW5kbGVzLmFjY2Vzc190eXBlX2lkID0gdXNlcnMuaWQgIjsKCQkJJGJhc2VTcWwgLj0gIkFORCAoYXBwQnVuZGxlcy5zdGF0dXM9JyIuTU1fU3RhdHVzOjokQUNUSVZFLiInIE9SIGFwcEJ1bmRsZXMuc3RhdHVzPSciLk1NX1N0YXR1czo6JFBFTkRJTkdfQ0FOQ0VMTEFUSU9OLiInKSBBTkQgYXBwQnVuZGxlcy5idW5kbGVfaWQgPSBidW5kbGVzLmlkICI7CgkJCQoJCQkkcmVzdWx0ID0gJHdwZGItPmdldF9yb3coJGJhc2VTcWwuIiBBTkQgYnVuZGxlcy5pc19mcmVlID0gJzAnOyIpOwoJCQkKCQkJaWYoJHJlc3VsdCkKCQkJewoJCQkJJHBhaWRCdW5kbGVzID0gJHJlc3VsdC0+dG90YWxfYnVuZGxlczsKCQkJfQoJCQllbHNlCgkJCXsKCQkJCSRwYWlkQnVuZGxlcyA9IDA7CgkJCX0KCQkJCgkJCSRzdGF0aXN0aWNzW3NlbGY6OiRVU0FHRV9QQUlEX0JVTkRMRVNdID0gJHBhaWRCdW5kbGVzOwoJCQkKCQkJLy8gRlJFRSBCVU5ETEVTIChVU0FHRSkKCQkJJHJlc3VsdCA9ICR3cGRiLT5nZXRfcm93KCRiYXNlU3FsLiIgQU5EIGJ1bmRsZXMuaXNfZnJlZSA9ICcxJzsiKTsKCQkJCgkJCWlmKCRyZXN1bHQpCgkJCXsKCQkJCSRmcmVlQnVuZGxlcyA9ICRyZXN1bHQtPnRvdGFsX2J1bmRsZXM7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkkZnJlZUJ1bmRsZXMgPSAwOwoJCQl9CgkJCQoJCQkkc3RhdGlzdGljc1tzZWxmOjokVVNBR0VfRlJFRV9CVU5ETEVTXSA9ICRmcmVlQnVuZGxlczsKCQoJCQkvLyBPUkRFUlMKCQkJJGJhc2VTcWwgPSAiU0VMRUNUIGNvdW50KG8uaWQpIGFzIHRvdGFsIEZST00gIi5NTV9UQUJMRV9PUkRFUlMuIiBvIjsKCQkJCgkJCSRyZXN1bHQgPSAkd3BkYi0+Z2V0X3JvdygkYmFzZVNxbCk7CgkJCQoJCQlpZigkcmVzdWx0KQoJCQl7CgkJCQkkb3JkZXJzID0gJHJlc3VsdC0+dG90YWw7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkkb3JkZXJzID0gMDsKCQkJfQoJCQkKCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JFVTQUdFX09SREVSU10gPSAkb3JkZXJzOwoJCQkKCQkJLy8gUEFZTUVOVCBNRVRIT0RTCgkJCSRwYXltZW50TWV0aG9kcyA9IGFycmF5KCk7CgkJCQoJCQkkc2VydmljZXMgPSBNTV9QYXltZW50U2VydmljZUZhY3Rvcnk6OmdldEF2YWlsYWJsZVBheW1lbnRTZXJ2aWNlcygpOwoJCQkJCgkJCWZvcmVhY2ggKCRzZXJ2aWNlcyBhcyAkc2VydmljZSkKCQkJewoJCQkJaWYgKCRzZXJ2aWNlIGluc3RhbmNlb2YgTU1fUGF5bWVudFNlcnZpY2UpCgkJCQl7CgkJCQkJYXJyYXlfcHVzaCgkcGF5bWVudE1ldGhvZHMsICRzZXJ2aWNlLT5nZXRUb2tlbigpKTsKCQkJCX0KCQkJfQoJCQkKCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19QQVlNRU5UX01FVEhPRFNdID0gam9pbigiLCAiLCAkcGF5bWVudE1ldGhvZHMpOwoJCQkKCQkJLy8gUEFJRCBNRU1CRVJTSElQIExFVkVMUwoJCQkkcGFpZE1lbWJlcnNoaXBzID0gTU1fTWVtYmVyc2hpcExldmVsOjpnZXRNZW1iZXJzaGlwTGV2ZWxzTGlzdChmYWxzZSwgTU1fTWVtYmVyc2hpcExldmVsOjokU1VCX1RZUEVfUEFJRCk7CgkJCQoJCQlpZigkcGFpZE1lbWJlcnNoaXBzICYmIGlzX2FycmF5KCRwYWlkTWVtYmVyc2hpcHMpKQoJCQl7CgkJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX01FTUJFUlNISVBTX1BBSURdID0gY291bnQoJHBhaWRNZW1iZXJzaGlwcyk7CgkJCX0KCQkJZWxzZSAKCQkJewoJCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19NRU1CRVJTSElQU19QQUlEXSA9IDA7CgkJCX0KCQkJCgkJCS8vIEZSRUUgTUVNQkVSU0hJUCBMRVZFTFMKCQkJJGZyZWVNZW1iZXJzaGlwcyA9IE1NX01lbWJlcnNoaXBMZXZlbDo6Z2V0TWVtYmVyc2hpcExldmVsc0xpc3QoZmFsc2UsIE1NX01lbWJlcnNoaXBMZXZlbDo6JFNVQl9UWVBFX0ZSRUUpOwoJCQkKCQkJaWYoJGZyZWVNZW1iZXJzaGlwcyAmJiBpc19hcnJheSgkZnJlZU1lbWJlcnNoaXBzKSkKCQkJewoJCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19NRU1CRVJTSElQU19GUkVFXSA9IGNvdW50KCRmcmVlTWVtYmVyc2hpcHMpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19NRU1CRVJTSElQU19GUkVFXSA9IDA7CgkJCX0KCQkJCgkJCS8vIFBBSUQgQlVORExFUwoJCQkkcGFpZEJ1bmRsZXMgPSBNTV9CdW5kbGU6OmdldEJ1bmRsZXNMaXN0KGZhbHNlLCBNTV9CdW5kbGU6OiRTVUJfVFlQRV9QQUlEKTsKCQkJCgkJCWlmKCRwYWlkQnVuZGxlcyAmJiBpc19hcnJheSgkcGFpZEJ1bmRsZXMpKQoJCQl7CgkJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0JVTkRMRVNfUEFJRF0gPSBjb3VudCgkcGFpZEJ1bmRsZXMpOwoJCQl9CgkJCWVsc2UKCQkJewoJCQkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19CVU5ETEVTX1BBSURdID0gMDsKCQkJfQoJCQkKCQkJLy8gRlJFRSBCVU5ETEVTCgkJCSRmcmVlQnVuZGxlcyA9IE1NX0J1bmRsZTo6Z2V0QnVuZGxlc0xpc3QoZmFsc2UsIE1NX0J1bmRsZTo6JFNVQl9UWVBFX0ZSRUUpOwoJCQkKCQkJaWYoJGZyZWVCdW5kbGVzICYmIGlzX2FycmF5KCRmcmVlQnVuZGxlcykpCgkJCXsKCQkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfQlVORExFU19GUkVFXSA9IGNvdW50KCRmcmVlQnVuZGxlcyk7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0JVTkRMRVNfRlJFRV0gPSAwOwoJCQl9CgkJCQoJCQkvLyBQUk9EVUNUUwoJCQkkcHJvZHVjdHMgPSBNTV9Qcm9kdWN0OjpnZXRBbGwoKTsKCQkJCgkJCWlmKCRwcm9kdWN0cyAmJiBpc19hcnJheSgkcHJvZHVjdHMpKQoJCQl7CgkJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX1BST0RVQ1RTXSA9IGNvdW50KCRwcm9kdWN0cyk7CgkJCX0KCQkJZWxzZQoJCQl7CgkJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX1BST0RVQ1RTXSA9IDA7CgkJCX0KCQkJCgkJCS8vIERFRkFVTFQgRU1QTE9ZRUUgQUNDT1VOVAoJCQkkZW1wbG95ZWUgPSBNTV9FbXBsb3llZTo6Z2V0RGVmYXVsdCgpOwoJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0RFRkFVTFRfRU1QTE9ZRUVfRU1BSUxdID0gIiI7CgkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfREVGQVVMVF9FTVBMT1lFRV9OQU1FXSA9ICIiOwoJCQkKCQkJaWYoJGVtcGxveWVlLT5pc1ZhbGlkKCkpCgkJCXsKCQkJCSRzdGF0aXN0aWNzW3NlbGY6OiRDT05GSUdfREVGQVVMVF9FTVBMT1lFRV9FTUFJTF0gPSAkZW1wbG95ZWUtPmdldEVtYWlsKCk7CgkJCQkkc3RhdGlzdGljc1tzZWxmOjokQ09ORklHX0RFRkFVTFRfRU1QTE9ZRUVfTkFNRV0gPSAkZW1wbG95ZWUtPmdldERpc3BsYXlOYW1lKCk7CgkJCX0KCQl9CgkJJHN0YXRpc3RpY3Nbc2VsZjo6JENPTkZJR19DVVJSRU5DWV0gPSBNTV9PcHRpb25VdGlsczo6Z2V0T3B0aW9uKE1NX09wdGlvblV0aWxzOjokT1BUSU9OX0tFWV9DVVJSRU5DWSk7CgkJCgkJcmV0dXJuICRzdGF0aXN0aWNzOwoJfQoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdlbmVyYXRlUHJvcGVydGllcygpCgl7CgkJZ2xvYmFsICR3cF92ZXJzaW9uOwoJCSRwcm9wZXJ0aWVzID0gYXJyYXkoKTsKCQkKCQkkcHJvcGVydGllc1tzZWxmOjokUFJPUFNfV1BfVkVSU0lPTl0gPSAkd3BfdmVyc2lvbjsKCQkkcHJvcGVydGllc1tzZWxmOjokUFJPUFNfUEhQX1ZFUlNJT05dID0gcGhwdmVyc2lvbigpOwoKCQlpZihNTV9JU19CRVRBID09IHRydWUpCgkJewoJCQkkcHJvcGVydGllc1tzZWxmOjokUFJPUFNfTU1fQkVUQV0gPSAidHJ1ZSI7CgkJfQoJCWVsc2UKCQl7CgkJCSRwcm9wZXJ0aWVzW3NlbGY6OiRQUk9QU19NTV9CRVRBXSA9ICJmYWxzZSI7CgkJfQoJCQoJCXJldHVybiAkcHJvcGVydGllczsKCX0KCQoJCgkvKiogUEVSTUlTU0lPTlMgKiovCgkKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9BVVRIT1JJWkVORVQgPSAicHltdF9zZXJ2aWNlX2F1dGhvcml6ZW5ldCI7CglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfQVVUSE9SSVpFTkVUX0NJTSA9ICJweW10X3NlcnZpY2VfYXV0aG9yaXplbmV0X2NpbSI7CglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfUEFZUEFMID0gInB5bXRfc2VydmljZV9wYXlwYWwiOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX0NMSUNLQkFOSyA9ICJweW10X3NlcnZpY2VfY2xpY2tiYW5rIjsKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9DSEFSR0lGWSA9ICJweW10X3NlcnZpY2VfY2hhcmdpZnkiOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX1NUUklQRSA9ICJweW10X3NlcnZpY2Vfc3RyaXBlIjsKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9CUkFJTlRSRUUgPSAicHltdF9zZXJ2aWNlX2JyYWludHJlZSI7CglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfTElNRUxJR0hUID0gInB5bXRfc2VydmljZV9saW1lbGlnaHQiOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX1NUSUNLWUlPID0gInB5bXRfc2VydmljZV9zdGlja3lpbyI7CglwdWJsaWMgc3RhdGljICRQWU1UX1NFUlZJQ0VfTElUTEUgPSAicHltdF9zZXJ2aWNlX2xpdGxlIjsKCXB1YmxpYyBzdGF0aWMgJFBZTVRfU0VSVklDRV9DT0lOQkFTRSA9ICJweW10X3NlcnZpY2VfY29pbmJhc2UiOwoJcHVibGljIHN0YXRpYyAkUFlNVF9TRVJWSUNFX1RXT0NIRUNLT1VUID0gInB5bXRfc2VydmljZV90d29jaGVja291dCI7CglwdWJsaWMgc3RhdGljICRNQVhfTlVNQkVSX01FTUJFUlMgPSAibWF4X251bWJlcl9tZW1iZXJzIjsKCXB1YmxpYyBzdGF0aWMgJFNIT1dfTU1fRk9PVEVSID0gInNob3dfbW1fZm9vdGVyIjsKCXB1YmxpYyBzdGF0aWMgJEZFQVRVUkVfQlVORExFUyA9ICJmZWF0dXJlX2J1bmRsZXMiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9EUklQX0NPTlRFTlRfU0NIRURVTEUgPSAiZmVhdHVyZV9kcmlwX2NvbnRlbnRfc2NoZWR1bGUiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9QSFBfSU5URVJGQUNFID0gImZlYXR1cmVfcGhwX2ludGVyZmFjZSI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX1BVU0hfTk9USUZJQ0FUSU9OUyA9ICJmZWF0dXJlX3B1c2hfbm90aWZpY2F0aW9ucyI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX0FQSSA9ICJmZWF0dXJlX2FwaSI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX1NNQVJUX0NPTlRFTlRfVEFHUyA9ICJmZWF0dXJlX3NtYXJ0X2NvbnRlbnRfdGFncyI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX0FGRklMSUFURV9NR01UID0gImZlYXR1cmVfYWZmaWxpYXRlX21nbXQiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9MT0FEX0JBTEFOQ0lORyA9ICJmZWF0dXJlX2xvYWRfYmFsYW5jaW5nIjsKCXB1YmxpYyBzdGF0aWMgJEZFQVRVUkVfRU1QTE9ZRUVfQUNDT1VOVFMgPSAiZmVhdHVyZV9lbXBsb3llZV9hY2NvdW50cyI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX0FEVl9TVUJTQ1JJUFRJT05fTUdNVCA9ICJmZWF0dXJlX2Fkdl9zdWJzY3JpcHRpb25fbWdtdCI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX1JFUE9SVElOR19TVUlURSA9ICJmZWF0dXJlX3JlcG9ydGluZ19zdWl0ZSI7CglwdWJsaWMgc3RhdGljICRGRUFUVVJFX0NPVVJTRV9RVUlaID0gImZlYXR1cmVfY291cnNlX3F1aXoiOwoJcHVibGljIHN0YXRpYyAkRkVBVFVSRV9DT1VSU0VfQ0VSVElGSUNBVEUgPSAiZmVhdHVyZV9jb3Vyc2VfY2VydGlmaWNhdGUiOwoJcHVibGljIHN0YXRpYyAkRVhURU5TSU9OX1VTRVJWT0lDRSA9ICJleHRlbnNpb25fdXNlcnZvaWNlIjsKCXB1YmxpYyBzdGF0aWMgJEVYVEVOU0lPTl9TT0NJQUxfTE9HSU4gPSAiZXh0ZW5zaW9uX3NvY2lhbF9sb2dpbiI7CglwdWJsaWMgc3RhdGljICRFWFRFTlNJT05fR09PR0xFX0VDT01NRVJDRSA9ICJleHRlbnNpb25fZ29vZ2xlX2Vjb21tZXJjZSI7CglwdWJsaWMgc3RhdGljICRFWFRFTlNJT05fQ09VUlNFUyA9ICJleHRlbnNpb25fY291cnNlcyI7CglwdWJsaWMgc3RhdGljICRTVVBQT1JUX0VNQUlMID0gInN1cHBvcnRfZW1haWwiOwoJcHVibGljIHN0YXRpYyAkU1VQUE9SVF9QSE9ORSA9ICJzdXBwb3J0X3Bob25lIjsKCXB1YmxpYyBzdGF0aWMgJFVOTElNSVRFRF9NRU1CRVJTID0gLTE7CgkKCXB1YmxpYyBzdGF0aWMgJEFDVElWRSA9IDE7CglwdWJsaWMgc3RhdGljICRJTkFDVElWRSA9IDA7CgkKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gaGFzUGVybWlzc2lvbigka2V5KQoJewoJCSRsaWNlbnNlID0gbmV3IE1NX0xpY2Vuc2UoKTsKCQkKCQlpZigkbGljZW5zZS0+aXNWYWxpZCgpKQoJCXsKCQkJJHBlcm1pc3Npb25zID0gJGxpY2Vuc2UtPmdldFBlcm1pc3Npb25zKCk7CgkJCQoJCQlpZigkcGVybWlzc2lvbnMpCgkJCXsKCQkJCSRwZXJtaXNzaW9ucyA9IGpzb25fZGVjb2RlKCRwZXJtaXNzaW9ucyk7CgkJCQkvKiogVEVTVElORyBQVVJQT1NFUyBPTkxZICoqLwoJCQkJaWYoJGtleSA9PSAicHltdF9zZXJ2aWNlX3R3b2NoZWNrb3V0IikKCQkJCXsKICAgICAgCQkJICAkcGVybWlzc2lvbnMtPiRrZXkgPSAxOwkKICAgICAgCQkgIH0KCQkJCQoJCQkJaWYoaXNfb2JqZWN0KCRwZXJtaXNzaW9ucykgJiYgaXNzZXQoJHBlcm1pc3Npb25zLT4ka2V5KSkKCQkJCXsKCQkJCQlyZXR1cm4gJHBlcm1pc3Npb25zLT4ka2V5OwoJCQkJfQoJCQl9CgkJCQoJCQlyZXR1cm4gc2VsZjo6JElOQUNUSVZFOwoJCX0KCX0KCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiBnZXRNZW1iZXJMaW1pdCgpCgl7CgkJJGxpY2Vuc2UgPSBuZXcgTU1fTGljZW5zZSgpOwoJCQoJCWlmKCRsaWNlbnNlLT5pc1ZhbGlkKCkpCgkJewoJCQkkcGVybWlzc2lvbnMgPSAkbGljZW5zZS0+Z2V0UGVybWlzc2lvbnMoKTsKCQkJCQoJCQlpZigkcGVybWlzc2lvbnMpCgkJCXsKCQkJCSRwZXJtaXNzaW9ucyA9IGpzb25fZGVjb2RlKCRwZXJtaXNzaW9ucyk7CgkJCQkKCQkJCWlmKGlzX29iamVjdCgkcGVybWlzc2lvbnMpICYmIGlzc2V0KCRwZXJtaXNzaW9ucy0+bWF4X251bWJlcl9tZW1iZXJzKSkKCQkJCXsKCQkJCQlyZXR1cm4gJHBlcm1pc3Npb25zLT5tYXhfbnVtYmVyX21lbWJlcnM7CgkJCQl9CgkJCX0KCQl9CgkJCgkJcmV0dXJuIC0xOwoJfQoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGdldFVwZ3JhZGVVcmwoJGZlYXR1cmU9IiIpCgl7CgkJcmV0dXJuICJodHRwczovL21lbWJlcm1vdXNlLmNvbS9wbGFucy8iOwoJfQoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBpbml0aWF0ZVBsdWdpbkRlYWN0aXZhdGlvbigpCgl7CgkJLy8gaWYgbG9nZ2VkIGluIGFzIGFuIGFkbWluIGFuZCBpbiB0aGUgYWRtaW4gYXJlYSwgZGlzYWJsZSB0aGUgcGx1Z2luIHRocm91Z2ggV29yZFByZXNzLCBvdGhlcndpc2UKCQkvLyBtYW51YWxseSBkZWFjdGl2YXRlIHRoZSBwbHVnaW4gdGhyb3VnaCB0aGUgZGF0YWJhc2UKCQlpZihpc19hZG1pbigpKQoJCXsKCQkJaWYoIXByZWdfbWF0Y2goIi8ocGx1Z2luc1wucGhwKS8iLCAkX1NFUlZFUlsiUEhQX1NFTEYiXSkpCgkJCXsKCQkJCU1NX0RpYWdub3N0aWNMb2c6OmxvZyhNTV9EaWFnbm9zdGljTG9nOjokTU1fRVJST1IsInBsdWdpbiBkZWFjdGl2YXRlZCBmcm9tIE1NX01lbWJlck1vdXNlU2VydmljZTo6aW5pdGlhdGVQbHVnaW5EZWFjdGl2YXRpb24iKTsKCQkJCWhlYWRlcigiTG9jYXRpb246IHBsdWdpbnMucGhwPyIuTU1fU2Vzc2lvbjo6JFBBUkFNX0NPTU1BTkRfREVBQ1RJVkFURS4iPTEmZGVhY3RpdmF0ZT10cnVlIik7CgkJCX0KCQl9CgkJZWxzZQoJCXsKCQkJc2VsZjo6bWFudWFsbHlEZWFjdGl2YXRlUGx1Z2luKCk7CgkJfQoJfQoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBtYW51YWxseURlYWN0aXZhdGVQbHVnaW4oKQoJewoJCSRwbHVnaW5zID0gZ2V0X29wdGlvbignYWN0aXZlX3BsdWdpbnMnKTsKCQoJCWlmKGlzX2FycmF5KCRwbHVnaW5zKSAmJiBjb3VudCgkcGx1Z2lucykgPiAwKQoJCXsKCQkJJHBsdWdpbk5hbWUgPSBNTV9QTFVHSU5fTkFNRS4iL2luZGV4LnBocCI7CgkJCSRrZXkgPSBhcnJheV9zZWFyY2goJHBsdWdpbk5hbWUsICRwbHVnaW5zLCB0cnVlKTsKCQkJCQoJCQlpZigka2V5ICE9PSBmYWxzZSkKCQkJewoJCQkJdW5zZXQoJHBsdWdpbnNbJGtleV0pOwoJCQl9CgkJCQkKCQkJdXBkYXRlX29wdGlvbigiYWN0aXZlX3BsdWdpbnMiLCAkcGx1Z2lucyk7CgkJCQoJCQkvLyBzZW5kIGFuIGVtYWlsIHRvIHRoZSBkZWZhdWx0IGVtcGxveWVlCgkJCSRlbXBsb3llZSA9IE1NX0VtcGxveWVlOjpnZXREZWZhdWx0KCk7CgkJCSRlbWFpbCA9IG5ldyBNTV9FbWFpbCgpOwoJCQkkZW1haWwtPnNldENvbnRleHQobmV3IE1NX0NvbnRleHQoKSk7CgkJCSRlbWFpbC0+c2V0U3ViamVjdCgiTWVtYmVyTW91c2UgZGVhY3RpdmF0ZWQgb24gIi5zaXRlX3VybCgpKTsgCgkJCSRlbWFpbC0+c2V0RnJvbU5hbWUoIk1lbWJlck1vdXNlIE5vdGlmaWNhdGlvbiIpOwoJCQkkZW1haWwtPnNldEZyb21BZGRyZXNzKCJkby1ub3QtcmVwbHlAbWVtYmVybW91c2UuY29tIik7CgkJCSRlbWFpbC0+c2V0VG9OYW1lKCRlbXBsb3llZS0+Z2V0Rmlyc3ROYW1lKCkpOwoJCQkkZW1haWwtPnNldFRvQWRkcmVzcygkZW1wbG95ZWUtPmdldEVtYWlsKCkpOwoJCQkKCQkJJGJvZHkgPSAiTWVtYmVyTW91c2UgaGFzIGJlZW4gZGVhY3RpdmF0ZWQgb24gIi5zaXRlX3VybCgpLiIuXG5cblRoaXMgaXMgbW9zdCBsaWtlbHkgYmVjYXVzZSB5b3VyIE1lbWJlck1vdXNlIGxpY2Vuc2UgaGFzIGV4cGlyZWQuXG5cbiI7CgkJCSRib2R5IC49ICJJZiB5b3UgdGhpbmsgdGhpcyB3YXMgZG9uZSBpbiBlcnJvciwgcGxlYXNlIGNvbnRhY3QgdXMgYXQgc3VwcG9ydEBtZW1iZXJtb3VzZS5jb20uXG5cblRoYW5rIHlvdSxcbk1lbWJlck1vdXNlIFN1cHBvcnQgVGVhbSI7CgkJCSRlbWFpbC0+c2V0Qm9keSgkYm9keSk7CgkJCQoJCQkkZW1haWwtPnNlbmQoKTsKCQkJCgkJCU1NX0RpYWdub3N0aWNMb2c6OmxvZyhNTV9EaWFnbm9zdGljTG9nOjokTU1fRVJST1IsInBsdWdpbiBkZWFjdGl2YXRlZCBmcm9tIE1NX01lbWJlck1vdXNlU2VydmljZTo6bWFudWFsbHlEZWFjdGl2YXRlUGx1Z2luKCkgb24gcGFnZSAiLiRfU0VSVkVSWyJQSFBfU0VMRiJdKTsKCQkJc2VsZjo6ZGVhY3RpdmF0ZVBsdWdpbigpOwoJCX0KCX0KCQoKCS8qKgoJICogSWYgYSBzaXRlIG1vdmVzIGRvbWFpbiBodHRwOi8vdXJsMS5jb20gdG8gaHR0cDovL3VybDIuY29tIGFuZCB0aGUgZGF0YWJhc2UgaXMgY3JlYXRlZAoJICogYXMgYW4gZXhhY3QgY29weSwgd2Ugd2FudCB0byByZXRyaWV2ZSB0aGUgc3RvcmVkIGNvcHkgb2YgbGljZW5zZS0+dXJsIGFuZCBlbnN1cmUgaXQgaXMgbWF0Y2hpbmcgdGhlIHNpdGV1cmwgaW4gd3Atb3B0aW9ucy4KCSAqIAoJICogU29tZSBhc3N1bXB0aW9uczoKCSAqIDEuIE1NX0xpY2Vuc2UtPnVybCBpcyBkZXJpdmVkIG9yaWdpbmFsbHkgZnJvbSAic2l0ZXVybCIgc28gdGhlcmVmb3JlIGhhcyB0byBtYXRjaC4gIAoJICogMi4gInNpdGV1cmwiIE1VU1QgYWN0dWFsbHkgbWF0Y2ggdGhlIGRvbWFpbiBiZWluZyB1c2VkIHN1Y2ggdGhhdCBXUCBmdW5jdGlvbnMgcHJvcGVybHkuICAKCSAqIDMuICJzaXRldXJsIiBtdXN0IGhhdmUgdGhlIGZvbGxvd2luZyBmb3JtYXQgaHR0cChzKTovLyh3d3cpKC4pP2FiYy5jb20KCSAqIAoJICogQHBhcmFtIE1NX0xpY2Vuc2UgJGNhY2hlZExpY2Vuc2UgaXMgdGhlIGxvY2FsIGxpY2Vuc2Ugb2JqZWN0CgkgKiBAcmV0dXJuIHRydWUgaWYgbG9jYWxseSBzdG9yZWQgJE9QVElPTl9LRVlfTElDRU5TRV9EQVRBIG9wdGlvbiBtYXRjaGVzIGEgcGFydCBvZiB0aGUgc2l0ZXVybC4KCSAqLwoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gaXNMb2NhbExpY2Vuc2VWYWxpZCgkY2FjaGVkTGljZW5zZSA9IG51bGwpCgl7IAoJICAgIGlmICgoJGNhY2hlZExpY2Vuc2UgIT0gbnVsbCkgJiYgKCRjYWNoZWRMaWNlbnNlIGluc3RhbmNlb2YgTU1fTGljZW5zZSkpCgkgICAgewoJICAgICAgICAkbGljZW5zZURhdGEgPSAkY2FjaGVkTGljZW5zZTsgICAKCSAgICB9CgkgICAgZWxzZSAKCSAgICB7CiAgICAJCSRsaWNlbnNlRGF0YSA9IE1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX0xJQ0VOU0VfREFUQSk7IAogICAgCQkkbGljZW5zZURhdGEgPSB1bnNlcmlhbGl6ZShiYXNlNjRfZGVjb2RlKCRsaWNlbnNlRGF0YSkpOyAKCSAgICB9CgkgCgkJaWYoIWVtcHR5KCRsaWNlbnNlRGF0YSkpCgkJeyAKCQkJJHVybCA9IHN0cnRvbG93ZXIoJGxpY2Vuc2VEYXRhLT51cmwpOwoKCQkJLy8vLyBsZXRzIHJlbW92ZSB0aGUgaHR0cChzKTovLyBhbmQgdGhlIHd3dyBwb3J0aW9uIG9mIHRoZSB0bGQuICAKCQkJLy8vLyB3ZSBhcmUgb25seSBpbnRlcmVzdGVkIGluIHNlZWluZyB0aGF0IHRoZSBsaWNlbnNlLT51cmwgbWF0Y2hzIHRoZSB1cmwyLmNvbSBkb21haW4uCgkJCSRiYXNlID0gcHJlZ19yZXBsYWNlKCIvKGh0dHBcOlwvXC98aHR0cHNcOlwvXC8pLyIsICIiLCAkdXJsKTsKCQkJJGJhc2VVcmwgPSBwcmVnX3JlcGxhY2UoIi9eKHd3d1wuKS8iLCAiIiwgJGJhc2UpOwoJCQkkYmFzZVVybCA9IHByZWdfcmVwbGFjZSgiLyhcLykkLyIsICIiLCAkYmFzZVVybCk7ICAKCgkJCSRzaXRldXJsID0gc3RydG9sb3dlcihzaXRlX3VybCgpKTsKCQkJCgkJCWlmKHN0cnBvcygkc2l0ZXVybCwkYmFzZVVybCkhPT1mYWxzZSkKCQkJewoJCQkgICAgc2VsZjo6JENBQ0hFRF9MSUNFTlNFX1ZBTElEQVRFRCA9IHRydWU7CgkJCQlyZXR1cm4gdHJ1ZTsKCQkJfQoJCQllbHNlCgkJCXsKCQkJICAgIE1NX0RpYWdub3N0aWNMb2c6OmxvZyhNTV9EaWFnbm9zdGljTG9nOjokTU1fRVJST1IsImxpY2Vuc2UgVVJMIGNoZWNrIGZhaWxlZCBmcm9tIGlzTG9jYWxMaWNlbnNlVmFsaWQoKSBsaWNlbnNlIFVSTDogJ3skYmFzZVVybH0nIFdQIHNpdGUgVVJMOiAneyRzaXRldXJsfSciKTsKCQkJfQoJCX0KCgkJLy8vLyBpbiB0aGlzIGNhc2UgdGhleSBkbyBub3QgbWF0Y2ggb3IgdGhlcmUgaXNuJ3QgYW55IHN0b3JlZCBkYXRhLCBzbyAKCQkvLy8vIHdlIHdpbGwgcmVtb3ZlIHRoZSBvcHRpb24gdmFsdWUgYW5kIGVuc3VyZSBhIHJlLWF1dGggb2NjdXJzCgkJTU1fT3B0aW9uVXRpbHM6OnNldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTElDRU5TRV9EQVRBLCIiKTsKCQlyZXR1cm4gZmFsc2U7Cgl9CgkKCS8qKiBMSUNFTlNFIEhFTFBFUiBNRVRIT0RTICoqLwoJLyoqCgkgKiBUaGUgZm9sbG93aW5nIG1ldGhvZHMgYXJlIGFzc29jaWF0ZWQgd2l0aCBhbmQgY2FsbGVkIGZyb20gdGhlIE1NX0xpY2Vuc2UgY2xhc3MuIFRoZXkncmUgcHV0IGhlcmUgdG8gZW5zdXJlCgkgKiB0aGUgaGlnaGVzdCBsZXZlbCBvZiBzZWN1cml0eSBob3dldmVyIHRoZSBhcHBsaWNhdGlvbiBzaG91bGRuJ3QgaW50ZXJhY3Qgd2l0aCB0aGVtIGRpcmVjdGx5IG9uIHRoaXMgY2xhc3MsCgkgKiB0aGV5IHNob3VsZCB1c2UgTU1fTGljZW5zZSBhcyB0aGUgbWFpbiBvYmplY3QgdG8gaW50ZXJmYWNlIHdpdGguCgkgKi8KCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gZ2V0TGljZW5zZShNTV9MaWNlbnNlICRsaWNlbnNlKQoJewoJCS8vYXR0ZW1wdCB0byByZXRyaWV2ZSBjYWNoZWQgbGljZW5zZSBvYmplY3QgZnJvbSBwcml2YXRlIHN0YXRpYyB2YXJpYWJsZS4gVGhpcyBwcmV2ZW50cyB1bm5lY2Vzc2FyeSBkYiBoaXQgYW5kIGRlY29kaW5nCgkJJGNhY2hlZE9iakV4aXN0cyA9IChzZWxmOjokQ0FDSEVEX0xJQ0VOU0VfT0JKICE9PSBudWxsKTsKCQlpZighc2VsZjo6JENBQ0hFRF9MSUNFTlNFX1ZBTElEQVRFRCAmJiAhc2VsZjo6aXNMb2NhbExpY2Vuc2VWYWxpZChzZWxmOjokQ0FDSEVEX0xJQ0VOU0VfT0JKKSkKCQl7CgkJCSRjYWNoZWRPYmpFeGlzdHMgPSBmYWxzZTsKCQl9CgoJCWlmICghJGNhY2hlZE9iakV4aXN0cykKCQl7IAoJCQkvL3JldHJpZXZlIGNhY2hlZCBsaWNlbnNlIGRhdGEgZnJvbSBvcHRpb24KCQkJJGxpY2Vuc2VEYXRhID0gTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbihNTV9PcHRpb25VdGlsczo6JE9QVElPTl9LRVlfTElDRU5TRV9EQVRBKTsKCQkJaWYoZW1wdHkoJGxpY2Vuc2VEYXRhKSB8fCBNTV9NZW1iZXJNb3VzZVNlcnZpY2U6OmRvQXV0aG9yaXplKCkpCgkJCXsKCQkJCU1NX01lbWJlck1vdXNlU2VydmljZTo6YXV0aG9yaXplKGZhbHNlKTsKCQkJCXNlbGY6OnJlbGVhc2VTZW1hcGhvcmUoKTsKCQkJCSRsaWNlbnNlRGF0YSA9IE1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX0xJQ0VOU0VfREFUQSk7CgkJCX0KCQkJCgkJCWlmKGVtcHR5KCRsaWNlbnNlRGF0YSkgJiYgTU1fVXRpbHM6OmlzTWVtYmVyTW91c2VBY3RpdmUoKSkKCQkJewoJCQkgICAgTU1fRGlhZ25vc3RpY0xvZzo6bG9nKE1NX0RpYWdub3N0aWNMb2c6OiRNTV9FUlJPUiwiaW5pdGlhdGUgcGx1Z2luIGRlYWN0aXZhdGlvbiBmcm9tIGdldExpY2Vuc2UoKSBiZWNhdXNlIGxpY2Vuc2UgZGF0YSBpcyBlbXB0eSIpOwoJCQkJTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjppbml0aWF0ZVBsdWdpbkRlYWN0aXZhdGlvbigpOwoJCQkJcmV0dXJuIGZhbHNlOwoJCQl9CgkJCQoJCQkvLyB1bm9iZnVzY2F0ZSBsaWNlbnNlIGRhdGEKCQkJJGxpY2Vuc2VEYXRhID0gdW5zZXJpYWxpemUoYmFzZTY0X2RlY29kZSgkbGljZW5zZURhdGEpKTsKCQkJaWYgKGlzX29iamVjdCgkbGljZW5zZURhdGEpKQoJCQl7CgkJCQlzZWxmOjokQ0FDSEVEX0xJQ0VOU0VfT0JKID0gJGxpY2Vuc2VEYXRhOwoJCQl9CgkJfQoJCWVsc2UgCgkJewoJCQkkbGljZW5zZURhdGEgPSBzZWxmOjokQ0FDSEVEX0xJQ0VOU0VfT0JKOwoJCX0KCQoJCWlmKCFpc19udWxsKCRsaWNlbnNlRGF0YSkgJiYgaXNzZXQoJGxpY2Vuc2VEYXRhLT5pZCkpCgkJewoJCQkkbGljZW5zZS0+c2V0SWQoJGxpY2Vuc2VEYXRhLT5pZCk7CgkJCSRsaWNlbnNlLT5zZXRNZW1iZXJJZCgkbGljZW5zZURhdGEtPm1lbWJlcklkKTsKCQkJJGxpY2Vuc2UtPnNldE5hbWUoJGxpY2Vuc2VEYXRhLT5uYW1lKTsKCQkJJGxpY2Vuc2UtPnNldFVybCgkbGljZW5zZURhdGEtPnVybCk7CgkJCSRsaWNlbnNlLT5zZXRBcGlLZXkoJGxpY2Vuc2VEYXRhLT5hcGlLZXkpOwoJCQkkbGljZW5zZS0+c2V0QXBpU2VjcmV0KCRsaWNlbnNlRGF0YS0+YXBpU2VjcmV0KTsKCQkJJGxpY2Vuc2UtPnNldE1ham9yVmVyc2lvbigkbGljZW5zZURhdGEtPm1ham9yVmVyc2lvbik7CgkJCSRsaWNlbnNlLT5zZXRNaW5vclZlcnNpb24oJGxpY2Vuc2VEYXRhLT5taW5vclZlcnNpb24pOwoJCQkkbGljZW5zZS0+c2V0UGVybWlzc2lvbnNQcm9maWxlSWQoJGxpY2Vuc2VEYXRhLT5wZXJtaXNzaW9uc1Byb2ZpbGVJZCk7CgkJCSRsaWNlbnNlLT5zZXRQZXJtaXNzaW9ucygkbGljZW5zZURhdGEtPnBlcm1pc3Npb25zKTsKCQkJJGxpY2Vuc2UtPnNldFN0YXR1cygkbGljZW5zZURhdGEtPnN0YXR1cyk7CgkJCSRsaWNlbnNlLT5zZXRMYXN0VXBkYXRlZCgkbGljZW5zZURhdGEtPmxhc3RVcGRhdGVkKTsKCQkJCgkJCWlmKGlzc2V0KCRsaWNlbnNlRGF0YS0+aXNTdGFnaW5nKSkKCQkJCSRsaWNlbnNlLT5zZXRBc1N0YWdpbmcoJGxpY2Vuc2VEYXRhLT5pc1N0YWdpbmcpOwoJCQkKCQkJJGxpY2Vuc2UtPnNldERhdGVBZGRlZCgkbGljZW5zZURhdGEtPmRhdGVBZGRlZCk7CgkJCSRsaWNlbnNlLT5zZXRBdXRoS2V5KGJhc2U2NF9lbmNvZGUoc2l0ZV91cmwoKSkpOwoJCQkkbGljZW5zZS0+dmFsaWRhdGUoKTsKCQl9IAoJfQoJCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIHN0b3JlTGljZW5zZShNTV9MaWNlbnNlICRsaWNlbnNlKQoJewoJCSRsaWNlbnNlRGF0YSA9IGJhc2U2NF9lbmNvZGUoc2VyaWFsaXplKHNlbGY6OnBhY2thZ2VVcExpY2Vuc2VEYXRhKCRsaWNlbnNlKSkpOwoJCU1NX09wdGlvblV0aWxzOjpzZXRPcHRpb24oTU1fT3B0aW9uVXRpbHM6OiRPUFRJT05fS0VZX0xJQ0VOU0VfREFUQSwgJGxpY2Vuc2VEYXRhKTsKCX0KCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiB2YWxpZGF0ZUxpY2Vuc2UoTU1fTGljZW5zZSAkbGljZW5zZSkKCXsKCQkkYXV0aEtleSA9IGJhc2U2NF9kZWNvZGUoJGxpY2Vuc2UtPmdldEF1dGhLZXkoKSk7CgkJCgkJaWYoZW1wdHkoJGF1dGhLZXkpIHx8ICgkYXV0aEtleSAhPSBzaXRlX3VybCgpKSkKCQl7CgkJICAgIE1NX0RpYWdub3N0aWNMb2c6OmxvZyhNTV9EaWFnbm9zdGljTG9nOjokTU1fRVJST1IsImluaXRpYXRlIHBsdWdpbiBkZWFjdGl2YXRpb24gZnJvbSB2YWxpZGF0ZUxpY2Vuc2UoKSBkdWUgdG8gYXV0aCBrZXkgbWlzbWF0Y2ggYXV0aEtleTogJ3skYXV0aEtleX0nIHNpdGV1cmw6ICciLnNpdGVfdXJsKCkuIiciKTsKCQkJc2VsZjo6aW5pdGlhdGVQbHVnaW5EZWFjdGl2YXRpb24oKTsKCQkJcmV0dXJuIGZhbHNlOwoJCX0KCX0KCQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gcGFja2FnZVVwTGljZW5zZURhdGEoTU1fTGljZW5zZSAkbGljZW5zZSkKCXsKCQkkZGF0YSA9IG5ldyBzdGRDbGFzcygpOwoJCgkJJGRhdGEtPmlkID0gJGxpY2Vuc2UtPmdldElkKCk7CgkJJGRhdGEtPm1lbWJlcklkID0gJGxpY2Vuc2UtPmdldE1lbWJlcklkKCk7CgkJJGRhdGEtPm5hbWUgPSAkbGljZW5zZS0+Z2V0TmFtZSgpOwoJCSRkYXRhLT51cmwgPSAkbGljZW5zZS0+Z2V0VXJsKCk7CgkJJGRhdGEtPmFwaUtleSA9ICRsaWNlbnNlLT5nZXRBcGlLZXkoKTsKCQkkZGF0YS0+YXBpU2VjcmV0ID0gJGxpY2Vuc2UtPmdldEFwaVNlY3JldCgpOwoJCSRkYXRhLT5tYWpvclZlcnNpb24gPSAkbGljZW5zZS0+Z2V0TWFqb3JWZXJzaW9uKCk7CgkJJGRhdGEtPm1pbm9yVmVyc2lvbiA9ICRsaWNlbnNlLT5nZXRNaW5vclZlcnNpb24oKTsKCQkkZGF0YS0+cGVybWlzc2lvbnNQcm9maWxlSWQgPSAkbGljZW5zZS0+Z2V0cGVybWlzc2lvbnNQcm9maWxlSWQoKTsKCQkkZGF0YS0+cGVybWlzc2lvbnMgPSAkbGljZW5zZS0+Z2V0UGVybWlzc2lvbnMoKTsKCQkkZGF0YS0+c3RhdHVzID0gJGxpY2Vuc2UtPmdldFN0YXR1cygpOwoJCSRkYXRhLT5pc0FyY2hpdmVkRmxhZyA9ICRsaWNlbnNlLT5pc0FyY2hpdmVkKCk7CgkJJGRhdGEtPmlzU3RhZ2luZyA9ICRsaWNlbnNlLT5pc1N0YWdpbmcoKTsKCQkkZGF0YS0+bGFzdFVwZGF0ZWQgPSAkbGljZW5zZS0+Z2V0TGFzdFVwZGF0ZWQoKTsKCQkkZGF0YS0+ZGF0ZUFkZGVkID0gJGxpY2Vuc2UtPmdldERhdGVBZGRlZCgpOwoJCgkJcmV0dXJuICRkYXRhOwoJfQoJCgkKCS8qKiBQUk9URUNURUQgVVRJTElURVMgKiovCglwdWJsaWMgc3RhdGljIGZ1bmN0aW9uIGVuY3J5cHRQYXNzd29yZCgkcGFzc3dvcmQpCgl7CgkgICAgaWYgKCFlbXB0eSgkcGFzc3dvcmQpKQoJICAgIHsKICAgIAkJZm9yKCRpPTA7ICRpPDU7ICRpKyspCiAgICAJCXsKICAgIAkJCSRwYXNzd29yZCA9IHN0cnJldihiYXNlNjRfZW5jb2RlKCRwYXNzd29yZCkpOwogICAgCQl9CgkgICAgfQoJCQkKCQlyZXR1cm4gJHBhc3N3b3JkOwoJfQoKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gZGVjcnlwdFBhc3N3b3JkKCRwYXNzd29yZCkKCXsKCSAgICBpZiAoIWVtcHR5KCRwYXNzd29yZCkpCgkgICAgewogICAgCQlmb3IoJGk9MDsgJGk8NTsgJGkrKykKICAgIAkJewogICAgCQkJJHBhc3N3b3JkID0gYmFzZTY0X2RlY29kZShzdHJyZXYoJHBhc3N3b3JkKSk7CiAgICAJCX0KCSAgICB9CgoJCXJldHVybiAkcGFzc3dvcmQ7Cgl9CgkKCQoJcHVibGljIHN0YXRpYyBmdW5jdGlvbiByZWd1bGF0ZVNjaGVkdWxpbmdFbnRyaWVzKCkKCXsKCSAgICBnbG9iYWwgJHdwZGI7CgkgICAgCgkJJGxvY2tOYW1lID0gc3Vic3RyKCJ7JHdwZGItPnByZWZpeH0tbW0tc2NoZWR1bGluZy1yZWd1bGF0b3IiLDAsNjMpOyAvL29wdGlvbiBhbmQgbG9jayBpZGVudGlmaWVyIGFyZSB0aGUgc2FtZQoJCSRkYXRhT3B0aW9uTmFtZSA9IHN1YnN0cigieyR3cGRiLT5wcmVmaXh9bW0tc2NocmVnLWRhdGEiLDAsNjMpOwoJCSRtZXRob2QgPSAicmVwb3J0RHVwbGljYXRlU2NoZWR1bGVzIjsKCSAgICAkdXJsID0gc2VsZjo6JFNFUlZFUklQLiRtZXRob2Q7CgkgICAgCgkgICAgJG9wdGlvblZhbHVlID0gTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbigkbG9ja05hbWUpOwoJICAgIAoJICAgIGlmICgkb3B0aW9uVmFsdWUgPT0gZmFsc2UpCgkgICAgewoJICAgICAgICAKCSAgICAgICAgJGxvY2tBY3F1aXJlZCA9ICR3cGRiLT5nZXRfdmFyKCJTRUxFQ1QgQ09BTEVTQ0UoR0VUX0xPQ0soJ3skbG9ja05hbWV9JywwKSwwKSIpOwoJICAgICAgICAKCSAgICAgICAgaWYgKCRsb2NrQWNxdWlyZWQgPT0gMSkgLy9iZWdpbiBsb2NrZWQgc2VjdGlvbgoJICAgICAgICB7CgkgICAgICAgICAgICAvL3NldCB0aW1lIGxpbWl0IHRvIGluZmluaXRlCgkgICAgICAgICAgICBzZXRfdGltZV9saW1pdCgwKTsKCSAgICAgICAgICAgIAoJICAgICAgICAgICAgLy91c2VkIGxhdGVyIHRvIGRldGVybWluZSBob3cgdG8gYWN0IGluIHRoZSBldmVudCBvZiB0cmFuc21pc3Npb24gZXJyb3JzCgkgICAgICAgICAgICAkc3RvcmVGb3JMYXRlciA9IGZhbHNlOwoJICAgICAgICAgICAgCgkgICAgICAgICAgICAkc2VUYWJsZSA9IE1NX1RBQkxFX1NDSEVEVUxFRF9FVkVOVFM7CgkgICAgICAgICAgICAkc3BUYWJsZSA9IE1NX1RBQkxFX1NDSEVEVUxFRF9QQVlNRU5UUzsKCSAgICAgICAgICAgIAoJICAgICAgICAgICAgLy9yZXRyaWV2ZSB1c2VyIGlkLCBvcmRlciBpZCwgb3JkZXIgbnVtYmVyLCBob3cgbWFueSBmdXR1cmUgc2NoZWR1bGVkIGV2ZW50cyB0aGVyZSBhcmUsIGFuZCBhIGxpc3Qgb2YgZXZlbnQgaWRzCgkgICAgICAgICAgICAvL2ZvciBldmVyeSBvcmRlciBpdGVtIHRoYXQgaGFzIG1vcmUgdGhhbiBvbmUgdW5wcm9jZXNzZWQgKHdlIGNhbiBhc3N1bWUgZnV0dXJlKSBzY2hlZHVsZWQgZXZlbnQKCSAgICAgICAgICAgIC8vdGhlc2UgdmlvbGF0ZSB0aGUgY29uc3RyYWludCB0aGF0IGV2ZXJ5IG9yZGVyIGl0ZW0gaGFzIGF0IG1vc3Qgb25lIGZ1dHVyZSBzY2hlZHVsZWQgcGF5bWVudCBldmVudAoJICAgICAgICAgICAgJHNxbCA9ICJTRUxFQ1QgQS5zY2hlZHVsZV9pZHMsIEEub3JkZXJfaXRlbV9pZCwgQS5mcmVxLCBvLmlkIEFTIG9yZGVyX2lkLCBvLm9yZGVyX251bWJlciwgby51c2VyX2lkIEZST00gIi4KCSAgICAgICAgICAgICIoU0VMRUNUIGdyb3VwX2NvbmNhdChzZS5pZCkgQVMgc2NoZWR1bGVfaWRzLCBzcC5vcmRlcl9pdGVtX2lkLCBDT1VOVCgxKSBBUyBmcmVxIEZST00geyRzZVRhYmxlfSBzZSBJTk5FUiBKT0lOIHskc3BUYWJsZX0gc3AgIi4KCSAgICAgICAgICAgICJPTiAoc2UuaWQgPSBzcC5pZCkgV0hFUkUgKHNlLnByb2Nlc3NlZF9kYXRlIElTIE5VTEwpIEdST1VQIEJZIHNwLm9yZGVyX2l0ZW1faWQgSEFWSU5HIGZyZXEgPiAxKSBBUyBBICIuCgkgICAgICAgICAgICAiSU5ORVIgSk9JTiBtbV9vcmRlcl9pdGVtcyBvaSBPTiAoQS5vcmRlcl9pdGVtX2lkID0gb2kuaWQpIElOTkVSIEpPSU4gbW1fb3JkZXJzIG8gT04gKG9pLm9yZGVyX2lkID0gby5pZCkiOwoJICAgICAgICAgICAgJG9jY3VycmVuY2VzID0gJHdwZGItPmdldF9yZXN1bHRzKCRzcWwpOwoJICAgICAgICAgICAgCgkgICAgICAgICAgICBpZiAoY291bnQoJG9jY3VycmVuY2VzKSA+IDApCgkgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgJGxpY2Vuc2UgPSBuZXcgTU1fTGljZW5zZSgiIixmYWxzZSk7CgkgICAgICAgICAgICAgICAgTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjpnZXRMaWNlbnNlKCRsaWNlbnNlKTsKCSAgICAgICAgICAgICAgICAkcGFja2FnZWREYXRhID0gYXJyYXkoImFwaV9rZXkiICAgICAgID0+ICRsaWNlbnNlLT5nZXRBcGlLZXkoKSwKCSAgICAgICAgICAgICAgICAgICAgImFwaV9zZWNyZXQiICAgICA9PiAkbGljZW5zZS0+Z2V0QXBpU2VjcmV0KCksCgkgICAgICAgICAgICAgICAgICAgICJjb21tYW5kIgkJICA9PiAicmVwb3J0RHVwbGljYXRlU2NoZWR1bGVzIiwKCSAgICAgICAgICAgICAgICAgICAgImRhdGEiIAkgICAgICA9PiAkb2NjdXJyZW5jZXMKCSAgICAgICAgICAgICAgICApOwoJICAgICAgICAgICAgICAgIAoJICAgICAgICAgICAgICAgIC8vc2VuZCBwYWNrYWdlZCBkYXRhIHRvIGNlbnRyYWwKCSAgICAgICAgICAgICAgICAKCSAgICAgICAgICAgICAgICAkcmVzcG9uc2UgPSB3cF9yZW1vdGVfcG9zdCgkdXJsLCBhcnJheSgnbWV0aG9kJyA9PiAnUE9TVCcsCgkgICAgICAgICAgICAgICAgICAgICd0aW1lb3V0JyA9PiAxMjAsCgkgICAgICAgICAgICAgICAgICAgICdib2R5Jz0+JHBhY2thZ2VkRGF0YSkpOwoJICAgICAgICAgICAgICAgIAoJICAgICAgICAgICAgICAgIGlmIChpc193cF9lcnJvcigkcmVzcG9uc2UpIHx8IChpc3NldCgkcmVzcG9uc2VbJ3Jlc3BvbnNlJ10pICYmIGlzc2V0KCRyZXNwb25zZVsncmVzcG9uc2UnXVsnY29kZSddKSAmJiAoJHJlc3BvbnNlWydyZXNwb25zZSddWydjb2RlJ10gIT0gIjIwMCIpKSB8fAoJICAgICAgICAgICAgICAgICAgICAoIWlzc2V0KCRyZXNwb25zZVsnYm9keSddKSkgKQoJICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgLy8gdW5hYmxlIHRvIGNvbm5lY3QgdG8gc2VydmVyCgkgICAgICAgICAgICAgICAgICAgICRzdG9yZUZvckxhdGVyID0gdHJ1ZTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgJGpzb24gPSBqc29uX2RlY29kZSgkcmVzcG9uc2VbJ2JvZHknXSk7CgkgICAgICAgICAgICAgICAgICAgIGlmICghaXNzZXQoJGpzb24tPnJlc3BvbnNlX2NvZGUpIHx8ICgkanNvbi0+cmVzcG9uc2VfY29kZSAhPSAiMjAwIikpCgkgICAgICAgICAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICAgICAgICAgICRzdG9yZUZvckxhdGVyID0gdHJ1ZTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICAKCSAgICAgICAgICAgICAgICBpZiAoJHN0b3JlRm9yTGF0ZXIpCgkgICAgICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICAgICB1cGRhdGVfb3B0aW9uKCRkYXRhT3B0aW9uTmFtZSwkb2NjdXJyZW5jZXMsdHJ1ZSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIAoJICAgICAgICAgICAgICAgIC8vbm93IHJlbW92ZSBkdXBsaWNhdGVkIHNjaGVkdWxlcwoJICAgICAgICAgICAgICAgIGZvcmVhY2ggKCRvY2N1cnJlbmNlcyBhcyAkb2NjdXJyZW5jZSkKCSAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChpc3NldCgkb2NjdXJyZW5jZS0+c2NoZWR1bGVfaWRzKSAmJiAoc3RycG9zKCRvY2N1cnJlbmNlLT5zY2hlZHVsZV9pZHMsIiwiKSAhPT0gZmFsc2UpKQoJICAgICAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgICAgICAvL3JlbW92ZSB0aGUgZmlyc3QgaWQsIGRlbGV0ZSB0aGUgcmVtYWluaW5nIGlkcwoJICAgICAgICAgICAgICAgICAgICAgICAgJHJlbWFpbmluZ1NjaGVkdWxlcyA9IHN1YnN0cigkb2NjdXJyZW5jZS0+c2NoZWR1bGVfaWRzLHN0cnBvcygkb2NjdXJyZW5jZS0+c2NoZWR1bGVfaWRzLCIsIikrMSk7CgkgICAgICAgICAgICAgICAgICAgICAgICAkZGVsZXRlUXVlcnlBID0gIkRFTEVURSBGUk9NIHskc2VUYWJsZX0gV0hFUkUgKHByb2Nlc3NlZF9kYXRlIElTIE5VTEwpIEFORCBpZCBJTiAoeyRyZW1haW5pbmdTY2hlZHVsZXN9KSI7CgkgICAgICAgICAgICAgICAgICAgICAgICAkd3BkYi0+cXVlcnkoJGRlbGV0ZVF1ZXJ5QSk7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICAgICAgCgkgICAgICAgICAgICAgICAgJGRlbGV0ZVF1ZXJ5QiA9ICJERUxFVEUgc3AgRlJPTSB7JHNwVGFibGV9IHNwIExFRlQgSk9JTiB7JHNlVGFibGV9IHNlIE9OIChzZS5pZCA9IHNwLmlkKSBXSEVSRSBzZS5pZCBJUyBOVUxMIjsKCSAgICAgICAgICAgICAgICAkd3BkYi0+cXVlcnkoJGRlbGV0ZVF1ZXJ5Qik7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICAKCSAgICAgICAgICAgIC8vc2V0IHRoZSBvcHRpb24gc28gdGhpcyBkb2Vzbid0IHJ1biBhZ2FpbgoJICAgICAgICAgICAgaWYgKCRzdG9yZUZvckxhdGVyKQoJICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgIHVwZGF0ZV9vcHRpb24oJGxvY2tOYW1lLCJwZW5kaW5nIix0cnVlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIGVsc2UKCSAgICAgICAgICAgIHsKCSAgICAgICAgICAgICAgICB1cGRhdGVfb3B0aW9uKCRsb2NrTmFtZSwiY29tcGxldGVkIix0cnVlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIAoJICAgICAgICAgICAgLy9lbmQgbG9ja2VkIHNlY3Rpb24KCSAgICAgICAgICAgICR3cGRiLT5xdWVyeSgiU0VMRUNUIFJFTEVBU0VfTE9DSygneyRsb2NrTmFtZX0nKSIpOwoJICAgICAgICB9CgkgICAgfQoJICAgIGVsc2UgaWYgKCRvcHRpb25WYWx1ZSA9PSAicGVuZGluZyIpCgkgICAgewoJICAgICAgICAkZGF0YU9wdGlvblZhbHVlID0gTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbigkZGF0YU9wdGlvbk5hbWUpOwoJICAgICAgICBpZiAoJGRhdGFPcHRpb25WYWx1ZSAhPT0gZmFsc2UpCgkgICAgICAgIHsKCSAgICAgICAgICAgIC8vdGhlIHNjaGVkdWxpbmcgcmVndWxhdG9yIGNvbXBsZXRlZCwgYnV0IHRoZXJlIHdhcyBwcmV2aW91c2x5IGFuIGlzc3VlIHNlbmRpbmcgdGhlIGRhdGEgdG8gY2VudHJhbCwgdHJ5IGFnYWluCgkgICAgICAgICAgICAkbGljZW5zZSA9IG5ldyBNTV9MaWNlbnNlKCIiLGZhbHNlKTsKCSAgICAgICAgICAgIE1NX01lbWJlck1vdXNlU2VydmljZTo6Z2V0TGljZW5zZSgkbGljZW5zZSk7CgkgICAgICAgICAgICAKCSAgICAgICAgICAgICRwYWNrYWdlZERhdGEgPSBhcnJheSgiYXBpX2tleSIgICAgICAgPT4gJGxpY2Vuc2UtPmdldEFwaUtleSgpLAoJICAgICAgICAgICAgICAgICJhcGlfc2VjcmV0IiAgICA9PiAkbGljZW5zZS0+Z2V0QXBpU2VjcmV0KCksCgkgICAgICAgICAgICAgICAgImNvbW1hbmQiCQkgID0+ICJyZXBvcnREdXBsaWNhdGVTY2hlZHVsZXMiLAoJICAgICAgICAgICAgICAgICJkYXRhIiAJICAgICAgPT4gJGRhdGFPcHRpb25WYWx1ZQoJICAgICAgICAgICAgKTsKCSAgICAgICAgICAgIAoJICAgICAgICAgICAgJHJlc3BvbnNlID0gd3BfcmVtb3RlX3Bvc3QoJHVybCwgYXJyYXkoJ21ldGhvZCcgPT4gJ1BPU1QnLAoJICAgICAgICAgICAgICAgICd0aW1lb3V0JyA9PiAxMjAsCgkgICAgICAgICAgICAgICAgJ2JvZHknPT4kcGFja2FnZWREYXRhKSk7CgkgICAgICAgICAgICAKCSAgICAgICAgICAgIGlmIChpc193cF9lcnJvcigkcmVzcG9uc2UpIHx8IChpc3NldCgkcmVzcG9uc2VbJ3Jlc3BvbnNlJ10pICYmIGlzc2V0KCRyZXNwb25zZVsncmVzcG9uc2UnXVsnY29kZSddKSAmJiAoJHJlc3BvbnNlWydyZXNwb25zZSddWydjb2RlJ10gIT0gIjIwMCIpKSB8fAoJICAgICAgICAgICAgICAgICghaXNzZXQoJHJlc3BvbnNlWydib2R5J10pKSApCgkgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgLy8gdW5hYmxlIHRvIGNvbm5lY3QgdG8gc2VydmVyCgkgICAgICAgICAgICAgICAgdXBkYXRlX29wdGlvbigkbG9ja05hbWUsImNvbXBsZXRlZCIsdHJ1ZSk7IC8vc2V0IG9wdGlvbiB0byBjb21wbGV0ZWQsIGJ1dCBsZWF2ZSB0aGUgZGF0YSBzbyBpdCBjYW4gcG90ZW50aWFsbHkgYmUgcmV0cmlldmVkIGxhdGVyCgkgICAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgZWxzZQoJICAgICAgICAgICAgewoJICAgICAgICAgICAgICAgICRqc29uID0ganNvbl9kZWNvZGUoJHJlc3BvbnNlWydib2R5J10pOwoJICAgICAgICAgICAgICAgIGlmIChpc3NldCgkanNvbi0+cmVzcG9uc2VfY29kZSkgJiYgKCRqc29uLT5yZXNwb25zZV9jb2RlID09ICIyMDAiKSkKCSAgICAgICAgICAgICAgICB7CgkgICAgICAgICAgICAgICAgICAgIGRlbGV0ZV9vcHRpb24oJGRhdGFPcHRpb25OYW1lKTsKCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICAgICAgLy9yZWdhcmRsZXNzIG9mIG91dGNvbWUsIHNldCBwYXRjaCBhcyBjb21wbGV0ZWQKCSAgICAgICAgdXBkYXRlX29wdGlvbigkbG9ja05hbWUsImNvbXBsZXRlZCIsdHJ1ZSk7CgkgICAgfQoJICAgIAoJfQoJCgkKCXB1YmxpYyBzdGF0aWMgZnVuY3Rpb24gcmVnaXN0ZXJPcnBoYW5lZFNjaGVkdWxlcygpCgl7CgkgICAgCiAgICAgICAgZ2xvYmFsICR3cGRiOwoJICAgIAoJICAgICRsb2NrTmFtZSA9IHN1YnN0cigieyR3cGRiLT5wcmVmaXh9bW0tdW5yZWctc2NoZWR1bGVzLXVwZGF0ZSIsMCw2Myk7IC8vb3B0aW9uIGFuZCBsb2NrIGlkZW50aWZpZXIgYXJlIHRoZSBzYW1lCgkgICAgJGRhdGFPcHRpb25OYW1lID0gc3Vic3RyKCJ7JHdwZGItPnByZWZpeH1tbS11bnJlZ3NjaGVkLWRhdGEiLDAsNjMpOwoJICAgICRtZXRob2QgPSAicmVwb3J0VW5yZWdpc3RlcmVkU2NoZWR1bGVzIjsKCSAgICAkdXJsID0gc2VsZjo6JFNFUlZFUklQLiRtZXRob2Q7CgkgICAgCiAgICAgICAgJGxvY2tBY3F1aXJlZCA9ICR3cGRiLT5nZXRfdmFyKCJTRUxFQ1QgQ09BTEVTQ0UoR0VUX0xPQ0soJ3skbG9ja05hbWV9JywwKSwwKSIpOyAgICAKICAgICAgICBpZiAoJGxvY2tBY3F1aXJlZCA9PSAxKSAvL2JlZ2luIGxvY2tlZCBzZWN0aW9uCiAgICAgICAgewogICAgICAgICAgICAkc2VUYWJsZSA9IE1NX1RBQkxFX1NDSEVEVUxFRF9FVkVOVFM7CiAgICAgICAgICAgICRzcFRhYmxlID0gTU1fVEFCTEVfU0NIRURVTEVEX1BBWU1FTlRTOwogICAgICAgICAgICAkb2lUYWJsZSA9IE1NX1RBQkxFX09SREVSX0lURU1TOwogICAgICAgICAgICAkb1RhYmxlICA9IE1NX1RBQkxFX09SREVSUzsKICAgICAgICAgICAgJHNhZmVEYXRlID0gZGF0ZSgiWS1tLWQgSDppIixzdHJ0b3RpbWUoIi0yNCBIb3VycyIpKTsKICAgICAgICAgICAgJG9wdGlvblZhbHVlID0gTU1fT3B0aW9uVXRpbHM6OmdldE9wdGlvbigkbG9ja05hbWUpOwogICAgICAgICAgICAKICAgICAgICAgICAgJHNxbEhlYWQgPSAiU0VMRUNUIHNlLmlkIEFTIGV2ZW50X2lkLCBjb25jYXQoby51c2VyX2lkLCcjJyxvLm9yZGVyX251bWJlcikgQVMgcmVjb3JkICI7CiAgICAgICAgICAgICRzcWxCb2R5ID0gIkZST00geyRzcFRhYmxlfSBzcCBJTk5FUiBKT0lOIHskc2VUYWJsZX0gc2UgT04gKHNwLmlkID0gc2UuaWQpICIuCiAgICAgICAgICAgICAgICAiSU5ORVIgSk9JTiB7JG9pVGFibGV9IG9pIE9OIChzcC5vcmRlcl9pdGVtX2lkID0gb2kuaWQpICIuCiAgICAgICAgICAgICAgICAiSU5ORVIgSk9JTiB7JG9UYWJsZX0gbyBPTiAob2kub3JkZXJfaWQgPSBvLmlkKSAiLgogICAgICAgICAgICAgICAgIkxFRlQgSk9JTiBtbV9xdWV1ZWRfc2NoZWR1bGVkX2V2ZW50cyBxIG9uIChzZS5pZCA9IHEuZXZlbnRfaWQpICIuCiAgICAgICAgICAgICAgICAiV0hFUkUgKHNlLnNjaGVkdWxlZF9kYXRlIDwgJ3skc2FmZURhdGV9JykgQU5EIChzZS5zdGF0dXMgPSAwKSBBTkQgKHNlLnByb2Nlc3NlZF9kYXRlIElTIE5VTEwpIEFORCAob2kuc3RhdHVzID0gMSkgQU5EIChxLmV2ZW50X2lkIElTIE5VTEwpIjsKICAgICAgICAgICAgCiAgICAgICAgICAgIC8vc2V0IHRpbWUgbGltaXQgdG8gaW5maW5pdGUKICAgICAgICAgICAgc2V0X3RpbWVfbGltaXQoMCk7CiAgICAgICAgICAgIAogICAgICAgICAgICBpZiAoJG9wdGlvblZhbHVlID09IGZhbHNlKSAvL25ldmVyIGJlZW4gc2V0CiAgICAgICAgICAgIHsgCiAgICAgICAgICAgICAgICAvL3VzZWQgbGF0ZXIgdG8gZGV0ZXJtaW5lIGhvdyB0byBhY3QgaW4gdGhlIGV2ZW50IG9mIHRyYW5zbWlzc2lvbiBlcnJvcnMKICAgICAgICAgICAgICAgICRzdG9yZUZvckxhdGVyID0gZmFsc2U7CiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIC8vZmluZCBvcnBoYW5lZCBzY2hlZHVsZXMKICAgICAgICAgICAgICAgICRzcWwgPSAkc3FsSGVhZC4kc3FsQm9keTsKICAgICAgICAgICAgICAgICR1bnJlZ1Jlc3VsdHMgPSAkd3BkYi0+Z2V0X3Jlc3VsdHMoJHNxbCk7CiAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgJHVucmVnT2JqID0gbmV3IHN0ZENsYXNzKCk7CiAgICAgICAgICAgICAgICAkdW5yZWdPYmotPmNvdW50ID0gY291bnQoJHVucmVnUmVzdWx0cyk7CiAgICAgICAgICAgICAgICAkdW5yZWdPYmotPmRhdGEgPSAiIjsKICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgIGlmICgkdW5yZWdPYmotPmNvdW50ID4gMCkKICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAkZmlyc3QgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIGZvcmVhY2ggKCR1bnJlZ1Jlc3VsdHMgYXMgJGFSZXN1bHQpCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICBpZiAoJGZpcnN0KQogICAgICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAkdW5yZWdPYmotPmRhdGEgPSAkYVJlc3VsdC0+cmVjb3JkOwogICAgICAgICAgICAgICAgICAgICAgICAgICAgJGZpcnN0ID0gZmFsc2U7CiAgICAgICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICAgICAgZWxzZSAKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHVucmVnT2JqLT5kYXRhIC49ICJ8eyRhUmVzdWx0LT5yZWNvcmR9IjsKICAgICAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgICAgICAKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgJGxpY2Vuc2UgPSBuZXcgTU1fTGljZW5zZSgiIixmYWxzZSk7CiAgICAgICAgICAgICAgICAgICAgTU1fTWVtYmVyTW91c2VTZXJ2aWNlOjpnZXRMaWNlbnNlKCRsaWNlbnNlKTsgLy9jYXVzZXMgYSByZW1vdGUgYXV0aD8KICAgICAgICAgICAgICAgICAgICAkcGFja2FnZWREYXRhID0gYXJyYXkoImFwaV9rZXkiICAgICAgICA9PiAkbGljZW5zZS0+Z2V0QXBpS2V5KCksCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJhcGlfc2VjcmV0IiAgICAgPT4gJGxpY2Vuc2UtPmdldEFwaVNlY3JldCgpLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY29tbWFuZCIJCSAgPT4gInJlcG9ydFVucmVnaXN0ZXJlZFNjaGVkdWxlcyIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICJkYXRhIiAJICAgICAgICAgID0+ICR1bnJlZ09iagogICAgICAgICAgICAgICAgICAgICk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgLy9zZW5kIHBhY2thZ2VkIGRhdGEgdG8gY2VudHJhbAogICAgICAgICAgICAgICAgICAgICRyZXNwb25zZSA9IHdwX3JlbW90ZV9wb3N0KCR1cmwsIGFycmF5KCdtZXRob2QnID0+ICdQT1NUJywKICAgICAgICAgICAgICAgICAgICAgICAgJ3RpbWVvdXQnID0+IDEyMCwKICAgICAgICAgICAgICAgICAgICAgICAgJ2JvZHknPT4kcGFja2FnZWREYXRhKSk7CiAgICAgICAgICAgICAgICAgICAgCiAgICAgICAgICAgICAgICAgICAgaWYgKGlzX3dwX2Vycm9yKCRyZXNwb25zZSkgfHwgKGlzc2V0KCRyZXNwb25zZVsncmVzcG9uc2UnXSkgJiYgaXNzZXQoJHJlc3BvbnNlWydyZXNwb25zZSddWydjb2RlJ10pICYmICgkcmVzcG9uc2VbJ3Jlc3BvbnNlJ11bJ2NvZGUnXSAhPSAiMjAwIikpIHx8ICghaXNzZXQoJHJlc3BvbnNlWydib2R5J10pKSApCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAvLyB1bmFibGUgdG8gY29ubmVjdCB0byBzZXJ2ZXIKICAgICAgICAgICAgICAgICAgICAgICAgJHN0b3JlRm9yTGF0ZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgIH0KICAgICAgICAgICAgICAgICAgICBlbHNlCiAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAkanNvbiA9IGpzb25fZGVjb2RlKCRyZXNwb25zZVsnYm9keSddKTsKICAgICAgICAgICAgICAgICAgICAgICAgaWYgKCFpc3NldCgkanNvbi0+cmVzcG9uc2VfY29kZSkgfHwgKCRqc29uLT5yZXNwb25zZV9jb2RlICE9ICIyMDAiKSkKICAgICAgICAgICAgICAgICAgICAgICAgewogICAgICAgICAgICAgICAgICAgICAgICAgICAgJHN0b3JlRm9yTGF0ZXIgPSB0cnVlOwogICAgICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgICAgIAogICAgICAgICAgICAgICAgICAgIGlmICgkc3RvcmVGb3JMYXRlcikKICAgICAgICAgICAgICAgICAgICB7CiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9vcHRpb24oJGRhdGFPcHRpb25OYW1lLCR1bnJlZ09iaix0cnVlKTsKICAgICAgICAgICAgICAgICAgICAgICAgLy9zZXQgdGhlIG9wdGlvbiBzbyB0aGlzIGRvZXNuJ3QgcnVuIGFnYWluCiAgICAgICAgICAgICAgICAgICAgICAgIHVwZGF0ZV9vcHRpb24oJGxvY2tOYW1lLCJwZW5kaW5nIix0cnVlKTsKICAgICAgICAgICAgICAgICAgICB9CiAgICAgICAgICAgICAgICAgICAgZWxzZQogICAgICAgICAgICAgICAgICAgIHsKICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlX29wdGlvbigkbG9ja05hbWUsImNvbXBsZXRlZCIsdHJ1ZSk7CiAgICAgICAgICAgICAgICAgICAgfQogICAgICAgICAgICAgICAgfQoJICAgICAgICAgfSAgCgkgICAgICAgICBlbHNlIGlmICgkb3B0aW9uVmFsdWUgPT0gInBlbmRpbmciKQoJICAgICAgICAgewogICAgICAgIAkgICAgICAgJGRhdGFPcHRpb25WYWx1ZSA9IE1NX09wdGlvblV0aWxzOjpnZXRPcHRpb24oJGRhdGFPcHRpb25OYW1lKTsKICAgICAgICAJICAgICAgIGlmICgkZGF0YU9wdGlvblZhbHVlICE9PSBmYWxzZSkKICAgICAgICAJICAgICAgIHsKICAgICAgICAJICAgICAgICAgICAvL3RoZSBzY2hlZHVsaW5nIHJlZ3VsYXRvciBjb21wbGV0ZWQsIGJ1dCB0aGVyZSB3YXMgcHJldmlvdXNseSBhbiBpc3N1ZSBzZW5kaW5nIHRoZSBkYXRhIHRvIGNlbnRyYWwsIHRyeSBhZ2FpbgogICAgICAgIAkgICAgICAgICAgICRsaWNlbnNlID0gbmV3IE1NX0xpY2Vuc2UoIiIsZmFsc2UpOwogICAgICAgIAkgICAgICAgICAgIE1NX01lbWJlck1vdXNlU2VydmljZTo6Z2V0TGljZW5zZSgkbGljZW5zZSk7CiAgICAgICAgCSAgICAgICAgICAgIAogICAgICAgIAkgICAgICAgICAgICRwYWNrYWdlZERhdGEgPSBhcnJheSgiYXBpX2tleSIgICAgICAgPT4gJGxpY2Vuc2UtPmdldEFwaUtleSgpLAogICAgICAgIAkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiYXBpX3NlY3JldCIgICAgPT4gJGxpY2Vuc2UtPmdldEFwaVNlY3JldCgpLAogICAgICAgIAkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiY29tbWFuZCIJCT0+ICJyZXBvcnRVbnJlZ2lzdGVyZWRTY2hlZHVsZXMiLAogICAgICAgIAkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAiZGF0YSIgCSAgICAgICAgPT4gJGRhdGFPcHRpb25WYWx1ZQogICAgICAgIAkgICAgICAgICAgICk7CiAgICAgICAgCSAgICAgICAgICAgIAogICAgICAgIAkgICAgICAgICAgICRyZXNwb25zZSA9IHdwX3JlbW90ZV9wb3N0KCR1cmwsIGFycmF5KCdtZXRob2QnID0+ICdQT1NUJywKICAgICAgICAJICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAndGltZW91dCcgPT4gMTIwLAogICAgICAgIAkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdib2R5Jz0+JHBhY2thZ2VkRGF0YSkpOwogICAgICAgIAkgICAgICAgICAgICAKICAgICAgICAJICAgICAgICAgICBpZiAoaXNfd3BfZXJyb3IoJHJlc3BvbnNlKSB8fCAoaXNzZXQoJHJlc3BvbnNlWydyZXNwb25zZSddKSAmJiBpc3NldCgkcmVzcG9uc2VbJ3Jlc3BvbnNlJ11bJ2NvZGUnXSkgJiYgKCRyZXNwb25zZVsncmVzcG9uc2UnXVsnY29kZSddICE9ICIyMDAiKSkgfHwgKCFpc3NldCgkcmVzcG9uc2VbJ2JvZHknXSkpICkKICAgICAgICAJICAgICAgICAgICB7CiAgICAgICAgCSAgICAgICAgICAgICAgIC8vIHVuYWJsZSB0byBjb25uZWN0IHRvIHNlcnZlcgogICAgICAgIAkgICAgICAgICAgICAgICBNTV9EaWFnbm9zdGljTG9nOjpsb2coTU1fRGlhZ25vc3RpY0xvZzo6JE1NX0VSUk9SLCAiVW5hYmxlIHRvIHRyYW5zbWl0IG9ycGhhbmVkIHNjaGVkdWxlIHJlc3VsdHMgdG8gY2VudHJhbDogIi5wcmludF9yKCRyZXNwb25zZSx0cnVlKSk7CiAgICAgICAgCSAgICAgICAgICAgfQogICAgICAgIAkgICAgICAgICAgIGVsc2UKICAgICAgICAJICAgICAgICAgICB7CiAgICAgICAgCSAgICAgICAgICAgICAgICRqc29uID0ganNvbl9kZWNvZGUoJHJlc3BvbnNlWydib2R5J10pOwogICAgICAgIAkgICAgICAgICAgICAgICBpZiAoaXNzZXQoJGpzb24tPnJlc3BvbnNlX2NvZGUpICYmICgkanNvbi0+cmVzcG9uc2VfY29kZSA9PSAiMjAwIikpCiAgICAgICAgCSAgICAgICAgICAgICAgIHsKICAgICAgICAJICAgICAgICAgICAgICAgICAgIGRlbGV0ZV9vcHRpb24oJGRhdGFPcHRpb25OYW1lKTsKICAgICAgICAJICAgICAgICAgICAgICAgfQogICAgICAgIAkgICAgICAgICAgIH0KICAgICAgICAJICAgICAgIH0KICAgICAgICAJICAgICAgIAogICAgICAgIAkgICAgICAgLy9yZWdhcmRsZXNzIG9mIG91dGNvbWUsIHNldCBwYXRjaCBhcyBjb21wbGV0ZWQKICAgICAgICAJICAgICAgIHVwZGF0ZV9vcHRpb24oJGxvY2tOYW1lLCJjb21wbGV0ZWQiLHRydWUpOwoJICAgICAgICAgIH0KCSAgICAgICAgICAgCgkgICAgICAgICAgLy9ub3cgZm9yY2UgcmVyZWdpc3RyYXRpb24gb2Ygb3JwaGFuZWQgc2NoZWR1bGVzIHVzaW5nIHRoZSBxdWV1ZSB0YWJsZQoJICAgICAgICAgICRxdWV1ZUNvbW1hbmQgPSAoY2xhc3NfZXhpc3RzKCJNTV9TY2hlZHVsZWRFdmVudCIsZmFsc2UpKT9NTV9TY2hlZHVsZWRFdmVudDo6JFFVRVVFX0NPTU1BTkRfVVBEQVRFOiIwIjsKCSAgICAgICAgICAkbm93ID0gTU1fVXRpbHM6OmdldEN1cnJlbnRUaW1lKCk7CgkgICAgICAgICAgJHJlZ3NxbFN1YnF1ZXJ5ID0gIlNFTEVDVCBzZS5pZCwgJ3skcXVldWVDb21tYW5kfScsICd7JG5vd30nIHskc3FsQm9keX0iOwoJICAgICAgICAgICRxVGFibGUgPSBNTV9UQUJMRV9RVUVVRURfU0NIRURVTEVEX0VWRU5UUzsKCSAgICAgICAgICAkcmVnc3FsUXVlcnkgPSAiSU5TRVJUIElOVE8geyRxVGFibGV9IChldmVudF9pZCwgY29tbWFuZCwgcXVldWVkX2RhdGUpIHskcmVnc3FsU3VicXVlcnl9IjsKCSAgICAgICAgICAkd3BkYi0+cXVlcnkoJHJlZ3NxbFF1ZXJ5KTsKCSAgICAKCSAgICAgICAgICAvL2VuZCBsb2NrZWQgc2VjdGlvbgoJICAgICAgICAgICR3cGRiLT5xdWVyeSgiU0VMRUNUIFJFTEVBU0VfTE9DSygneyRsb2NrTmFtZX0nKSIpOwogICAgICAgIH0KCX0KCQoJCglwcml2YXRlIHN0YXRpYyBmdW5jdGlvbiBzZW5kV2FybmluZ0VtYWlsKCkKCXsKCQlpZiAoY2xhc3NfZXhpc3RzKCJNTV9FbWFpbCIpICYmIGZ1bmN0aW9uX2V4aXN0cygid3BfbWFpbCIpKQoJCXsKCQkgICAgJHNpdGVVcmwgPSBzaXRlX3VybCgpOwoJCQkkZW1wbG95ZWUgPSBNTV9FbXBsb3llZTo6Z2V0RGVmYXVsdCgpOwoJCQkkZW1haWwgPSBuZXcgTU1fRW1haWwoKTsKCQkJJGVtYWlsLT5zZXRDb250ZXh0KG5ldyBNTV9Db250ZXh0KCkpOwoJCQkkZW1haWwtPnNldFN1YmplY3QoIkFMRVJUIC0gTWVtYmVyTW91c2UgZGVhY3RpdmF0aW9uIHdhcm5pbmcgZm9yIHskc2l0ZVVybH0iKTsKCQkJJGVtYWlsLT5zZXRGcm9tTmFtZSgiTWVtYmVyTW91c2UgTm90aWZpY2F0aW9uIik7CgkJCSRlbWFpbC0+c2V0RnJvbUFkZHJlc3MoImRvLW5vdC1yZXBseUBtZW1iZXJtb3VzZS5jb20iKTsKCQkJJGVtYWlsLT5zZXRUb05hbWUoJGVtcGxveWVlLT5nZXRGaXJzdE5hbWUoKSk7CgkJCSRlbWFpbC0+c2V0VG9BZGRyZXNzKCRlbXBsb3llZS0+Z2V0RW1haWwoKSk7CgkJCQkKCQkJJGJvZHkgPSAiVGhpcyBpcyBhbiBhdXRvbWF0ZWQgbm90aWNlIHRvIGluZm9ybSB5b3UgdGhhdCBjb21tdW5pY2F0aW9uIGJldHdlZW4gdGhlIE1lbWJlck1vdXNlIHBsdWdpbiAiLgoJCQkJCSJvbiB5b3VyIHNpdGUgdG8gdGhlIE1lbWJlck1vdXNlIGNlbnRyYWwgc2VydmVyIGhhcyBiZWVuIGZhaWxpbmcgb24gYSBjb25zaXN0ZW50IGJhc2lzLiBUaGUgIi4KCQkJCQkibWFpbiBjYXVzZXMgZm9yIHRoaXMgYXJlIG5ldHdvcmsgb3V0YWdlcyBvciBibG9ja3MgYnkgc2VjdXJpdHkgcGx1Z2lucy5cblxuIi4KCQkJCQkiV2UgcmVjb21tZW5kOlxuMSkgdGhhdCB5b3Ugd29yayB3aXRoIHlvdXIgaG9zdCBwcm92aWRlciB0byByZXZpZXcgc2VydmVyIGxvZ3Mgb3ZlciB0aGUgIi4KCQkJCQkicGFzdCBjb3VwbGUgb2YgZGF5cyB0byBzZWUgaWYgdGhlcmUgYXJlIGFueSBlcnJvcnMgdG8gaW5kaWNhdGUgd2hhdCBtaWdodCBiZSBvY2N1cnJpbmcgdG8gIi4KCQkJCQkiY2F1c2UgdGhpcy4gXG4iLgoJCQkJCSIyKSByZXZpZXcgYW55IG5ldyBzZWN1cml0eSBzZXR0aW5ncyBvbiB0aGUgc2VydmVyIG9yIHNlY3VyaXR5IHBsdWdpbnMgdGhhdCBtaWdodCBoYXZlIGJlZW4gIi4KCQkJCQkiYWRkZWQsIGFzIHRoZXNlIGNhbiBpbnRlcmZlcmUgd2l0aCBjb21tdW5pY2F0aW9uXG5cbkFmdGVyIGdhdGhlcmluZyB0aGlzIGluZm9ybWF0aW9uICIuCgkJCQkJImFuZCBtYWtpbmcgYW55IG5lY2Vzc2FyeSBjaGFuZ2VzLCBwbGVhc2UgY29udGFjdCB0aGUgTWVtYmVyTW91c2UgU3VwcG9ydCBUZWFtIGF0ICIuCgkJCQkJInN1cHBvcnRAbWVtYmVybW91c2UuY29tIHNvIHdlIGNhbiBtb25pdG9yIHlvdXIgbGljZW5zZSBhbmQgbWFrZSBzdXJlIHRoYXQgeW91ciBwbHVnaW4gIi4KCQkJCQkic3VjY2Vzc2Z1bGx5IGF1dGhvcml6ZXMuXG5JTVBPUlRBTlQ6IElmIHRoZSBzaXR1YXRpb24gaXMgbm90IGZpeGVkIHdpdGhpbiA3IGRheXMsICIuCgkJCQkJInRoZSBNZW1iZXJNb3VzZSBwbHVnaW4gd2lsbCBkZWFjdGl2YXRlLiI7CgkJCSRlbWFpbC0+c2V0Qm9keSgkYm9keSk7CgkJCQkKCQkJJGVtYWlsLT5zZW5kKCk7CgkJfQoJfQoJCgkKCXByaXZhdGUgc3RhdGljIGZ1bmN0aW9uIGFjcXVpcmVTZW1hcGhvcmUoKQoJewoJCWdsb2JhbCAkd3BkYjsKCQkKCQlpZiAoIWlzX29iamVjdCgkd3BkYikpCgkJewoJCQlyZXR1cm4gLTE7IC8vZXJyb3IKCQl9CgoJCSRsb2NrQWNxdWlyZWQgPSAkd3BkYi0+Z2V0X3Zhcigkd3BkYi0+cHJlcGFyZSgiU0VMRUNUIElGKElTX0ZSRUVfTE9DSyglcyksQ09BTEVTQ0UoR0VUX0xPQ0soJXMsMCksLTEpLDApIixzZWxmOjokQVVUSF9MT0NLX0lERU5USUZJRVIsc2VsZjo6JEFVVEhfTE9DS19JREVOVElGSUVSKSk7CgkJaWYgKCRsb2NrQWNxdWlyZWQgPT0gIjEiKQoJCXsKCQkJc2VsZjo6JEFVVEhfTE9DSyA9IHRydWU7CgkJfQoJCXJldHVybiBpbnR2YWwoJGxvY2tBY3F1aXJlZCk7IC8vLTEgZXJyb3IsIDAgbm90IGFjcXVpcmVkLCAxIGFjcXVpcmVkCgl9CgkKCQoJcHJpdmF0ZSBzdGF0aWMgZnVuY3Rpb24gcmVsZWFzZVNlbWFwaG9yZSgpCgl7CgkJZ2xvYmFsICR3cGRiOwoJCQoJCWlmIChpc19vYmplY3QoJHdwZGIpICYmIHNlbGY6OiRBVVRIX0xPQ0spCgkJewoJCQkkd3BkYi0+cXVlcnkoJHdwZGItPnByZXBhcmUoIlNFTEVDVCBSRUxFQVNFX0xPQ0soJXMpIixzZWxmOjokQVVUSF9MT0NLX0lERU5USUZJRVIpKTsKCQkJc2VsZjo6JEFVVEhfTE9DSyA9IGZhbHNlOwoJCX0KCX0KfQoK', '1', NOW());";
		if($wpdb->query($addSql) === false)
		{	
			return false;
		}
		return true;
 	}
 	
 	public function authenticateWithMM()
 	{
 		if(class_exists("MM_MemberMouseService"))
 		{
	 		return MM_MemberMouseService::authorize();
 		}
 		return false;
 	}
 	
 	private function alterMMTables()
 	{
 		global $wpdb;
 		
 		$filename = "install_sql";
 		require_once(MM_PLUGIN_ABSPATH."/data/{$filename}.php");	

		if (isset($sql) && count($sql)>0)
		{
			dbdelta($sql);
		}
		
		// Since DBDelta doesn't handle dropping column, here's where we can do it manually & safely. We first 
		// check to see if the column even exists. This could happen if a client has deactivated the 
		// plugin for some reason and then decides to reactivate.
		$droppedColumns = array();
		$droppedColumns[MM_TABLE_USER_DATA][] = "password";
		
		foreach($droppedColumns as $table => $columns)
		{
			foreach($columns as $column)
			{
				if($this->hasColumn($table, $column))
				{
					$wpdb->query("ALTER TABLE {$table} DROP COLUMN {$column}");
				}
			}
		}
		
		//Drop the log api table, it has been replaced with on-demand diagnostic logging
		$wpdb->query("DROP TABLE IF EXISTS mm_log_api");
		
 		return true;
 	} 	
 	
	private function hasColumn($table, $column)
	{
		global $wpdb;
		
 		$sql = "SELECT COUNT(*) as total FROM information_schema.columns WHERE table_name = '{$table}' AND column_name = '{$column}'"; 
 		$row = $wpdb->get_row($sql);
 		return ($row->total>0);
	}
	
 	private function hasRecords($table, $column, $where)
 	{
 		global $wpdb;
 		
 		$sql = "select count(*) as total from {$table} where {$column}='".addslashes($where)."'"; 
 		$row = $wpdb->get_row($sql);
 		return ($row->total>0);
 	}
 	
 	
 	private function insertMMDefaultData()
 	{
 		global $wpdb, $current_user;
		
 		// insert default option values
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACCT_SECURITY_ENABLED, MM_OptionUtils::$DEFAULT_ACCT_SECURITY_ENABLED);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACCT_SECURITY_MAX_IPS, MM_OptionUtils::$DEFAULT_ACCT_SECURITY_MAX_IPS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ON_LOGIN_USE_WP_FRONTPAGE, MM_OptionUtils::$DEFAULT_ON_LOGIN_USE_WP_FRONTPAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFTER_LOGIN_USE_WP_FRONTPAGE, MM_OptionUtils::$DEFAULT_AFTER_LOGIN_USE_WP_FRONTPAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SHOW_LOGIN_LOGOUT_LINK, MM_OptionUtils::$DEFAULT_SHOW_LOGIN_LOGOUT_LINK);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_HIDE_PROTECTED_MENU_ITEMS, MM_OptionUtils::$DEFAULT_HIDE_PROTECTED_MENU_ITEMS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_LOGIN_PAGE, MM_OptionUtils::$DEFAULT_USE_MM_LOGIN_PAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_RESET_PASSWORD_PAGE, MM_OptionUtils::$DEFAULT_USE_MM_RESET_PASSWORD_PAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DFLT_COUNTRY_SELECTION, MM_OptionUtils::$DEFAULT_COUNTRY_ISO);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGOT_PASSWORD_SUBJECT, MM_OptionUtils::$DEFAULT_FORGOT_PASSWORD_SUBJECT);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGOT_PASSWORD_BODY, MM_OptionUtils::$DEFAULT_FORGOT_PASSWORD_BODY);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFFILIATE, MM_OptionUtils::$DEFAULT_AFFILIATE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SUB_AFFILIATE, MM_OptionUtils::$DEFAULT_SUB_AFFILIATE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFFILIATE_LIFESPAN, MM_OptionUtils::$DEFAULT_AFFILIATE_LIFESPAN);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_LOGIN_TOKEN_LIFESPAN, MM_OptionUtils::$DEFAULT_LOGIN_TOKEN_LIFESPAN);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_CHECKOUT_FORM_TEST_DATA, MM_OptionUtils::$DEFAULT_USE_CHECKOUT_FORM_TEST_DATA);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_CONFIRMATION_DIALOG_WIDTH, MM_OptionUtils::$DEFAULT_PURCHASE_CONFIRMATION_DIALOG_WIDTH);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_CONFIRMATION_DIALOG_HEIGHT, MM_OptionUtils::$DEFAULT_PURCHASE_CONFIRMATION_DIALOG_HEIGHT);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DEFAULT_CHECKOUT_ITEM_TYPE, MM_OptionUtils::$DEFAULT_CHECKOUT_ITEM_TYPE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DEFAULT_CHECKOUT_ITEM_ID, MM_OptionUtils::$DEFAULT_CHECKOUT_ITEM_ID);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SHOW_PREVIEW_BAR, MM_OptionUtils::$DEFAULT_SHOW_PREVIEW_BAR);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_HIDE_ADMIN_BAR, MM_OptionUtils::$DEFAULT_HIDE_ADMIN_BAR);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ENABLE_WP_AUTOP, MM_OptionUtils::$DEFAULT_ENABLE_WP_AUTOP);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ENABLE_USERNAME_CHANGE, MM_OptionUtils::$DEFAULT_ENABLE_USERNAME_CHANGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ALLOW_LOGGED_OUT_PURCHASES, MM_OptionUtils::$DEFAULT_ALLOW_LOGGED_OUT_PURCHASES);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ALLOW_DUPLICATE_SUBSCRIPTIONS, MM_OptionUtils::$DEFAULT_ALLOW_DUPLICATE_SUBSCRIPTIONS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CHECKOUT_PAID_MESSAGE, MM_OptionUtils::$DEFAULT_CHECKOUT_PAID_MESSAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CHECKOUT_FREE_MESSAGE, MM_OptionUtils::$DEFAULT_CHECKOUT_FREE_MESSAGE);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CHECKOUT_MESSAGE_CSS, MM_OptionUtils::$DEFAULT_CHECKOUT_MESSAGE_CSS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CURRENCY, MM_OptionUtils::$DEFAULT_CURRENCY);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_JQUERY_UI, MM_OptionUtils::$DEFAULT_USE_JQUERY_UI);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ALLOW_OVERDUE_ACCESS, MM_OptionUtils::$DEFAULT_ALLOW_OVERDUE_ACCESS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CAPTCHA_ENABLED, MM_OptionUtils::$DEFAULT_CAPTCHA_ENABLED);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_RESET_PASSWORD, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DIAGNOSTIC_MODE, MM_DiagnosticLog::$MODE_OFF);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORCE_USE_DB_CACHE, 0);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CURRENCY_FORMAT_POSTFIX_ISO, 'false');
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFFILIATE_ALIAS, "");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SUB_AFFILIATE_ALIAS, "");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_AFFILIATE_LIFESPAN, "");
		
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SITE_IN_TEST_MODE, "0"); //0 for false, 1 for true
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CAPTCHA_KEY, "");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CAPTCHA_PRIVATE_KEY, "");
		
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_EMAIL_ADDRESS, "1");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_ADDRESS, "1");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_ADDRESS_COUNTRY, "1");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_ORDER_ADDRESS, "1");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_ORDER_COUNTRY, "1");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_ACTIVITY_LOG, "1");
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_FORGET_MEMBER_CUSTOM_FIELDS, "1");
		
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_LIMELIGHT_USE_REBILL_PRODUCT, MM_OptionUtils::$DEFAULT_LIMELIGHT_USE_REBILL_PRODUCT);
		MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_STICKYIO_USE_REBILL_PRODUCT, MM_OptionUtils::$DEFAULT_STICKYIO_USE_REBILL_PRODUCT);
		
		// options that vary based on if this is an upgrade versus a new install
		$lastMajorVersion = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_MAJOR_VERSION);
		
		if(empty($lastMajorVersion))
		{
			// set options for new installs
			// for 2.0.7 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DISABLE_EXPLICIT_LINKS, MM_OptionUtils::$DEFAULT_DISABLE_EXPLICIT_LINKS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_LINK_STYLE, MM_OptionUtils::$DEFAULT_PURCHASE_LINK_STYLE);
			
			// for 2.0.8 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SMARTTAG_VERSION, MM_OptionUtils::$DEFAULT_SMARTTAG_VERSION);
			
			// for 2.0.9 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACTIVITY_LOG_CLEANUP_ENABLED, MM_OptionUtils::$DEFAULT_ACTIVITY_LOG_CLEANUP_ENABLED);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACTIVITY_LOG_CLEANUP_INTERVAL, MM_OptionUtils::$DEFAULT_ACTIVITY_LOG_CLEANUP_INTERVAL);
			
			// for 2.1.2 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_CHECKOUT, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_MY_ACCOUNT, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_LOGIN, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_FORGOT_PASSWORD, MM_OptionUtils::$DEFAULT_USE_MM_CSS);
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ENABLE_MEMBERSHIP_PRORATION, MM_OptionUtils::$DEFAULT_ENABLE_MEMBERSHIP_PRORATION);
			
			// for 2.2.5 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DRIP_CONTENT_TIME_SETTING, MM_OptionUtils::$DEFAULT_DRIP_CONTENT_TIME_SETTING);
			
			// for 2.4.0 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CAPTCHA_VERSION, MM_OptionUtils::$DEFAULT_CAPTCHA_VERSION);
		}
		else
		{
			// set options for existing installs
			// for 2.0.7 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DISABLE_EXPLICIT_LINKS, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_PURCHASE_LINK_STYLE, MM_LINK_STYLE_EXPLICIT);
			
			// for 2.0.8 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_SMARTTAG_VERSION, "2.0");
			
			// for 2.0.9 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACTIVITY_LOG_CLEANUP_ENABLED, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ACTIVITY_LOG_CLEANUP_INTERVAL, "");

			// for 2.1.2 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_CHECKOUT, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_MY_ACCOUNT, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_LOGIN, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_USE_MM_CSS_FORGOT_PASSWORD, "0");
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_ENABLE_MEMBERSHIP_PRORATION, "0");
			
			// for 2.2.5 release
			if(class_exists('MM_ProtectedContentEngine'))
			{
				MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DRIP_CONTENT_TIME_SETTING, MM_ProtectedContentEngine::$TIME_SETTING_SERVER);
			}
			else
			{
				MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_DRIP_CONTENT_TIME_SETTING, MM_OptionUtils::$DEFAULT_DRIP_CONTENT_TIME_SETTING);
			}
			
			// for 2.4.0 release
			MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_CAPTCHA_VERSION, "2");
			
			
			// when upgrading from releases < 2.2.5
			if (version_compare($lastMajorVersion,'2.2.4','<='))
			{
				$wpdb->query("ALTER TABLE ".MM_TABLE_TRANSACTION_LOG." MODIFY COLUMN order_id BIGINT(20) UNSIGNED NOT NULL");
				$wpdb->query("ALTER TABLE ".MM_TABLE_TRANSACTION_LOG." MODIFY COLUMN order_item_id BIGINT(20) UNSIGNED");
			}
		}
 		
 		MM_Role::addRoles();
 		
	 	// create default employee account if one doesn't exist, using the current user
	 	$install_sql = "select * from ".MM_TABLE_EMPLOYEE_ACCOUNTS." where is_default='1' LIMIT 1;";
	 	$row = $wpdb->get_row($install_sql);
	 	if($row == null)
	 	{
	 		//the current user isn't an employee
	 		$install_sql = "insert into ".MM_TABLE_EMPLOYEE_ACCOUNTS." set display_name='%s', email='%s', is_default='%d', role_id='%s', user_id='%d'";
	 		$displayName = (!empty($current_user->display_name)) ? $current_user->display_name : "Support";
	 		$wpdb->query($wpdb->prepare($install_sql, $displayName, $current_user->user_email, 1, MM_Role::$ROLE_ADMINISTRATOR, $current_user->ID));
	 		$emailId = $wpdb->insert_id;
	 	}
	 	else 
	 	{
	 		$emailId = $row->id;
	 	}
	 	
	 	// install default overdue payment notification email
	 	$crntValue = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_OVERDUE_PAYMENT_NOTIFICATION_INSTALLED);
	 	if(class_exists('MM_Action') && ($crntValue === false || $crntValue === ""))
	 	{
	 		$action = new MM_Action();
	 		$action->setEventType(MM_Event::$MEMBER_STATUS_CHANGE);
	 		$action->setActionType(MM_Action::$MM_ACTION_SEND_EMAIL);
	 			
	 		$emailToId = MM_Action::$CURRENT_MEMBER_PLACEHOLDER;
	 		$emailFromId = $emailId;
	 		$emailCC = "";
	 		$emailSubject = MM_OptionUtils::$DEFAULT_OVERDUE_PAYMENT_SUBJECT;
	 		$emailBody = MM_OptionUtils::$DEFAULT_OVERDUE_PAYMENT_BODY;
	 		$action->setActionValue(MM_Action::prepareSendEmailValue($emailToId, $emailFromId, $emailCC, $emailSubject, $emailBody));
	 			
	 		// set attributes
	 		$attributes = array();
	 		$attributes["status_id"] = MM_Status::$OVERDUE;
	 		$action->setEventAttributes($attributes);
	 		
	 		$result = $action->commitData();
	 		
	 		if(MM_Response::isSuccess($result))
	 		{
	 			MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_OVERDUE_PAYMENT_NOTIFICATION_INSTALLED, "1");
	 		}
	 	}
	 	
 		// create default membership level
	 	if(!$this->hasRecords(MM_TABLE_MEMBERSHIP_LEVELS, 'is_default', '1'))
	 	{
		 	$install_sql = "INSERT INTO ".MM_TABLE_MEMBERSHIP_LEVELS." SET " .
			 			"	name = 'Free Membership'," .
			 			"	is_free='1'," .
			 			"	is_default='1'," .
			 			"	status='1'," .
			 			"	description='Default Free Membership'," .
			 			"	email_subject='%s'," .
			 			"	email_body='%s'," .
			 			"	email_from_id='%d'" .
			 			"";
		 	
		 	$wpdb->query($wpdb->prepare($install_sql, MM_MembershipLevel::$DFLT_EMAIL_SUBJECT, MM_MembershipLevel::$DFLT_EMAIL_BODY, $emailId));
	 	}
	 	
	 	// create default commission profile
	 	if(!$this->hasRecords(MM_TABLE_COMMISSION_PROFILES, 'is_default', '1'))
	 	{
	 		$install_sql = "INSERT INTO ".MM_TABLE_COMMISSION_PROFILES." SET " .
	 				"	name = 'Standard Commission Profile'," .
		 			"	is_default='1'," .
		 			"	description='This is the default commission profile'," .
		 			"	initial_commission_enabled='1'," .
		 			"	rebill_commissions_enabled='0'," .
		 			"	rebill_commission_type='default'," .
		 			"	rebill_commission_value='0'," .
		 			"	do_limit_rebill_commissions='0'," .
		 			"	rebill_commission_limit='0', " .
		 			"	do_reverse_commissions='1'" .
	 				"";
	 	
	 		$wpdb->query($install_sql);
	 	}
 		
 		// make sure active payment services are updated
 		if(class_exists('MM_PaymentServiceFactory') && class_exists('MM_PaymentService'))
 		{
	 		$services = MM_PaymentServiceFactory::getAvailablePaymentServices();
	 			
	 		foreach ($services as $service)
	 		{
	 			if ($service instanceof MM_PaymentService)
	 			{
	 				$service->install();
	 			}
	 		}
 		}
 		
 		//add smart tags
	 	$this->addSmartTags();
	 	
	 	$sql = "select count(*) as total from ".MM_TABLE_API_KEYS;
	 	$row = $wpdb->get_row($sql);
	 	
	 	if($row->total<=0)
	 	{
	 		$sql = "insert into ".MM_TABLE_API_KEYS." set ".
		 		   "name='Default Access', ".
		 		   "api_key='".MM_Utils::createRandomString(10)."',	".
		 		   "api_secret='".MM_Utils::createRandomString(10)."', ".
		 		   "status='1'";
	 		
		 	$wpdb->query($sql);
	 	}
	 	
	 	$sql = array();
	 	require_once(MM_PLUGIN_ABSPATH."/data/countries.sql.php");
	 	$numCountries = count($sql);
	 	$countryCheckSql = "select count(*) as total from ".MM_TABLE_COUNTRIES;
	 	$row = $wpdb->get_row($countryCheckSql);
	 	if ($row->total < $numCountries)
	 	{
	 		foreach ($sql as $query)
	 		{
	 			if($wpdb->query($query) === false)
	 			{
	 				return false;
	 			}
	 		}
	 	}
	 	unset($sql);
	 	
	 	// set default country selections to have all countries selected
	 	$sql = "SELECT iso, printable_name from ".MM_TABLE_COUNTRIES." order by printable_name asc";
	 	$results = $wpdb->get_results($sql, OBJECT_K);
	 	$defaultSelections = array();
	 	
	 	foreach ($results as $iso=>$row)
	 	{
	 	    $defaultSelections[$iso] = $iso;
	 	}
	 	
	 	MM_OptionUtils::setDefaultValue(MM_OptionUtils::$OPTION_KEY_COUNTRY_SELECTIONS, $defaultSelections);
	 	
	 	$sql = array();
	 	require_once(MM_PLUGIN_ABSPATH."/data/country_subdivisions.sql.php");
	 	$numCountrySubdivisions = count($sql);
	 	$countrySubdivisionCheckSql = "select count(*) as total from ".MM_TABLE_COUNTRY_SUBDIVISIONS;
	 	$row = $wpdb->get_row($countrySubdivisionCheckSql);
	 	if ($row->total < $numCountrySubdivisions)
	 	{
	 		foreach ($sql as $query)
	 		{
	 			if($wpdb->query($query) === false)
	 			{
	 				return false;
	 			}
	 		}
	 	}
	 	unset($sql);
		
	 	$result = $this->setupCorePages();
	 	
	 	if(!$result)
	 	{
	 		return false;
	 	}
	 	
	 	$cacheWriteable = @MM_Utils::cacheIsWriteable();
	 		
	 	$sql = array();
	 		
	 	//TODO TRANSIENT: in version 2.0.1 renamed WordPress Mail to None. Once all customers have been upgraded to None then this 
	 	// if statement can be removed
	 	if($this->hasRecords(MM_TABLE_EMAIL_SERVICE_PROVIDERS, 'provider_token', 'default'))
	 	{
	 		$sql[] = "UPDATE ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='None' WHERE provider_token='default';";
	 	}
	 	else 
	 	{
	 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='None', provider_token='default', active='1';";
	 	}
	 
	 	//email service providers
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='ActiveCampaign', provider_token='activecampaign', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='MailChimp', provider_token='mailchimp', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='iContact', provider_token='icontact', api_key='".MM_IContactEmailServiceProvider::$API_KEY."'";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='AWeber', provider_token='aweber', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_EMAIL_SERVICE_PROVIDERS." SET provider_name='GetResponse', provider_token='getresponse', active='0';";
	 	
	 	//affiliate providers
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_AFFILIATE_PROVIDERS." SET provider_name='None', provider_token='default', active='1';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_AFFILIATE_PROVIDERS." SET provider_name='iDevAffiliate', provider_token='idevaffiliate';";
	 		
	 	//payment services
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='PAYPAL', name='PayPal', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='AUTHORIZENET', name='Authorize.net', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='AUTHORIZENETCIM', name='Authorize.net CIM', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='BRAINTREE', name='Braintree', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='CHARGIFY', name='Chargify', settings='', active='0';";
	 	
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='STICKYIO', name='Sticky.io', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='LIMELIGHT', name='Lime Light (Legacy)', settings='', active='0';";
	 	
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='STRIPE', name='Stripe', settings='', active='0';";
		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='TWOCHECKOUT', name='2Checkout', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='CLICKBANK', name='ClickBank', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='LITLE', name='Litle', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='COINBASE', name='Coinbase (Wallet Required)', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='COINBASEMINIMAL', name='Coinbase (Wallet Ignored)', settings='', active='0';";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_PAYMENT_SERVICES." SET token='TEST', name='Test Payment Service', settings='', active='0';";
	 	
	 	//shipping methods
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_SHIPPING_METHODS." SET token='FLATRATE', name='Flat Rate', settings='', active='1';"; //active by default
	 	
	 	foreach ($sql as $query)
	 	{
	 		$wpdb->query($query);
	 	}
	 	unset($sql);
	 	
	 	
	 	//apply any updates that may have been made to the schemas of the active payment services
	 	$activePaymentServices = MM_PaymentServiceFactory::getAvailablePaymentServices();
	 	foreach ($activePaymentServices as $ps)
	 	{
	 		$ps->install();
	 	}
	 	
		// Need to search and replace any remnants of [MM_Member_Data name='password'] in 
		// Forgot Password email with the new Reset Password Core Page Link Smart Tag
		$pattern 			  = "\[mm_member_data name=(['|\"]{1})password(['|\"]{1})\]";
		$forgotPasswordBody = MM_OptionUtils::getOption(MM_OptionUtils::$OPTION_KEY_FORGOT_PASSWORD_BODY);
		$forgotPasswordBody = preg_replace("/{$pattern}/i", "<a href=\"[MM_CorePage_Link type='resetpassword']\">click here to reset your password</a>", $forgotPasswordBody);
		MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_FORGOT_PASSWORD_BODY, $forgotPasswordBody);
		
	 	return true;
 	}
 	
 	
 	public function setupCorePages()
 	{
 		global $wpdb, $current_user;
 		
 		// Core Page Types
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$MEMBER_HOME_PAGE."','Member Home','1');";
	 	$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$SAVETHESALE."','Save the Sale','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$ERROR."','Error','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$LOGIN_PAGE."','Login','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$FORGOT_PASSWORD."','Forgot Password','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$RESET_PASSWORD."','Reset Password','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$CHECKOUT."','Checkout','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$REDEEM_GIFT."','Redeem Gift','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$PAID_CONFIRMATION."','Confirmation','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$FREE_CONFIRMATION."','Free Confirmation','0');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$MY_ACCOUNT."','My Account','1');";
 		$sql[] = "INSERT IGNORE INTO ".MM_TABLE_CORE_PAGE_TYPES." (id, name, visible) VALUES ('".MM_CorePageType::$LOGOUT_PAGE."','Logout','1');";
 			
	 	// Default Core Pages
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('1', '".MM_CorePageType::$MEMBER_HOME_PAGE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('2', '".MM_CorePageType::$SAVETHESALE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('3', '".MM_CorePageType::$ERROR."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('4', '".MM_CorePageType::$LOGIN_PAGE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('5', '".MM_CorePageType::$FORGOT_PASSWORD."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('6', '".MM_CorePageType::$CHECKOUT."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('7', '".MM_CorePageType::$PAID_CONFIRMATION."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('9', '".MM_CorePageType::$FREE_CONFIRMATION."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('10', '".MM_CorePageType::$MY_ACCOUNT."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('11', '".MM_CorePageType::$LOGOUT_PAGE."');";
 		$sql[] ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (id, core_page_type_id) VALUES ('12', '".MM_CorePageType::$REDEEM_GIFT."');";
	 	
	 	foreach($sql as $query)
	 	{
	 		if($wpdb->query($query) === false)
	 		{
	 			echo $query;
	 			return false;
	 		}
	 	}
	 	unset($sql);
 		
	 	// Install Default Core Pages
	 	$templateParams = new stdClass();
	 	$templateParams->resourceDirectory = MM_RESOURCES_URL;
	 	$mm_template_base = MM_PLUGIN_ABSPATH."/templates";
	 	
		// Member Homepage
 		$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$MEMBER_HOME_PAGE."' and ref_type IS NULL and page_id IS NULL";
 		$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
	 	{	
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 				"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/homepage.html.php", $templateParams))."', '[MM_Member_Data name=\"membershipName\"] Home Page', '".$this->getPostName('home')."');";
	 		
 			if(!$wpdb->query($sql))
 			{
 				echo $query;
 				return false;
 			}
 			
 			$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$MEMBER_HOME_PAGE);
	 	}
	 	
	 	// Save-the-Sale Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$SAVETHESALE."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/cancel.html.php", $templateParams))."', 'Cancel Membership', '".$this->getPostName('cancel')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$SAVETHESALE);
	 	}
	 	
	 	// Error Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$ERROR."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
		{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/error.html.php", $templateParams))."', 'Error', '".$this->getPostName('mm-error')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$ERROR);
	 	}
	 	
	 	// Login Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$LOGIN_PAGE."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/login.html.php", $templateParams))."', 'Login', '".$this->getPostName('login')."');";
		 		
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$LOGIN_PAGE);
	 	}

	 	// Logout Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$LOGOUT_PAGE."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/logout.html.php", $templateParams))."', 'Logout', '".$this->getPostName('logout')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$LOGOUT_PAGE);
	 	}
	 	
	 	// Forgot Password Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$FORGOT_PASSWORD."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/forgotpassword.html.php", $templateParams))."', 'Forgot Password', '".$this->getPostName('forgot-password')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$FORGOT_PASSWORD);
	 	}
	 	
	 	// Reset Password Page
	 	// remove corrupt reset password core pages
	 	$removeCorruptResetPasswordSql = "DELETE FROM ".MM_TABLE_CORE_PAGES." WHERE core_page_type_id = '".MM_CorePageType::$RESET_PASSWORD."' AND (page_id IS NULL || page_id = '');";
	 	$wpdb->query($removeCorruptResetPasswordSql);
	 	
	 	$corePageSql = "select id, page_id, count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$RESET_PASSWORD."'";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	// it's possible that the reset password core page isn't being installed as a result of some corrupt 
	 	// core pages that we only partially installed (the page_id == NULL checks for that). We want to detect 
	 	// these so that their presense doesn't keep the fully functional page from being installed.
	 	if($row->total == 0 || $row->page_id == NULL)
	 	{	
	 		// create row in mm_core_pages table
	 		$resetPasswordSql ="INSERT IGNORE INTO ".MM_TABLE_CORE_PAGES." (core_page_type_id) VALUES ('".MM_CorePageType::$RESET_PASSWORD."');";
	 		
	 		if(!$wpdb->query($resetPasswordSql))
	 		{
	 			echo $resetPasswordSql;
	 			return false;
	 		}
	 		
	 		$resetCorePageId = $wpdb->insert_id;
	 		
	 		// create reset password page
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 		"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/resetpassword.html.php", $templateParams))."', 'Reset Password', '".$this->getPostName('reset-password')."');";
	 		
	 		if(!$wpdb->query($sql))
	 		{
	 			echo $sql;
	 			return false;
	 		}
	 		
	 		// link row in mm_core_pages table to reset password page
 			$this->linkCorePage($wpdb->insert_id, $resetCorePageId);
	 	}
	 	
	 	// Checkout Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$CHECKOUT."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/checkout.html.php", $templateParams))."', 'Checkout', '".$this->getPostName('checkout')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$CHECKOUT);
	 	}
	 	
	 	// Redeem Gift Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$REDEEM_GIFT."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
	 		$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
	 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/redeemgift.html.php", $templateParams))."', 'Redeem Gift', '".$this->getPostName('redeem-gift')."');";
	 				
	 		if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$REDEEM_GIFT);
	 	}
	 	
	 	// My Account Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$MY_ACCOUNT."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/myaccount.html.php", $templateParams))."', 'My Account', '".$this->getPostName('myaccount')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$MY_ACCOUNT);
	 	}
	 	
	 	// Paid Confirmation Page
	 	$corePageSql = "select count(*) as total from ".MM_TABLE_CORE_PAGES." where core_page_type_id = '".MM_CorePageType::$PAID_CONFIRMATION."' and ref_type IS NULL and page_id IS NULL";
	 	$row = $wpdb->get_row($corePageSql);
	 	 
	 	if($row->total > 0)
	 	{
		 	$sql = "insert into {$wpdb->posts} (post_type, post_author, post_date, post_status,post_content, post_title, post_name) " .
		 			"		values ('page',$current_user->ID, NOW(), 'publish','".addslashes(MM_TEMPLATE::generate($mm_template_base."/default_templates/confirmation.html.php", $templateParams))."', 'Thank You', '".$this->getPostName('confirmation')."');";
		 			
		 	if(!$wpdb->query($sql))
	 		{
	 			echo $query;
	 			return false;
	 		}
	 			
	 		$this->linkCorePage($wpdb->insert_id, MM_CorePageType::$PAID_CONFIRMATION);
	 	}
	 	
 		return true;
 	}
 	
 	private function addSmartTags()
 	{
 		global $wpdb;
 		
 		$wpdb->query("DELETE FROM ".MM_TABLE_SMARTTAGS);
 		require_once(MM_PLUGIN_ABSPATH."/data/smarttags.sql.php");
 		if(isset($sql) && is_array($sql))
 		{
 			foreach($sql as $query)
 			{
 				if($wpdb->query($query)===false){ 
 					return false;	
 				}
 			}
 		}
 		
 		//clear global SmartTag cache
 		MM_OptionUtils::setOption(MM_OptionUtils::$OPTION_KEY_SMARTTAGS);
 		
 		return true;
 	}
 	
 	private function getPostName($suggestedName=""){
 		global $wpdb;
 		$sql = "select count(*) as total from {$wpdb->posts} where post_name='".$suggestedName."'";
 		$row = $wpdb->get_row($sql);
 		if($row->total>0){
	 		$sql = "select post_name from {$wpdb->posts} where post_name like '".$suggestedName."-%'";
	 		$rows = $wpdb->get_results($sql);
	 		
	 		$index=1;
	 		while(true){
	 			$newName = $suggestedName."-".$index;
	 			$hasName = false;
	 			foreach($rows as $row){
	 				if($row->post_name == $newName){
	 					$hasName = true;		
	 				}
	 			}
	 			if(!$hasName){
	 				return $newName;
	 			}
	 			$index++;
	 		}
 		}
 		return $suggestedName;
 	}
 	
 	private function linkCorePage($page_id, $id)
 	{
		global $wpdb;
		$sql = "update ".MM_TABLE_CORE_PAGES." set page_id='{$page_id}' where id='{$id}'";
		
		if(!$wpdb->query($sql))
		{
			echo $sql;
			return false;
		}
 	}
 	
	private function field_exists($column, $table)
	{
		global $wpdb;
		$sql = "describe {$table}";
		$rows = $wpdb->get_results($sql);
	
		for($i=0; $i<count($rows); $i++)
		{
			if($column == $rows[$i]->Field)
			{
				return true;
			}
		}
		
		return false;
	}
	
	private function getFieldType($column, $table)
	{
		global $wpdb;
		$sql = "describe {$table}";
		$rows = $wpdb->get_results($sql);
		
		$numRows = count($rows);
		for($i=0; $i<$numRows; $i++)
		{
			if($column == $rows[$i]->Field)
			{
				return $rows[$i]->Type;
			}
		}
		
		return false;
	}
 }