/**
 *
 * MemberMouse(TM) (http://www.membermouse.com)
 * (c) MemberMouse, LLC. All rights reserved.
 */
class MM_Queue extends MM_Entity
{
	const MM_STATUS_COMPLETE=1;
	const MM_STATUS_PENDING=0;
	const MM_STATUS_QUEUED=2;

	private $pipeline = "";
	private $data = ""; 
	private $status = "0"; 
	private $dateAdded = ""; 
	
	public function getDataByPipeline() 
	{
		global $wpdb;
		
		$sql = "SELECT * FROM ".MM_TABLE_QUEUE." WHERE pipeline='".$this->pipeline."';";
		$result = $wpdb->get_row($sql);
		
		if($result) {
            $this->id = $result->id;
			$this->setData($result);
		}
		else {
			parent::invalidate();
		}
    }  
	
	public function getData() 
	{
		global $wpdb;
		
		$sql = "SELECT * FROM ".MM_TABLE_QUEUE." WHERE id='".$this->id."';";
		$result = $wpdb->get_row($sql);
		
		if($result) {
			$this->setData($result);
		}
		else {
			parent::invalidate();
		}
    }  

    public static function cleanup($pipeline)
    {
		global $wpdb;
		
		$sql = "DELETE FROM ".MM_TABLE_QUEUE."  where status='".self::MM_STATUS_COMPLETE."' ";
		$wpdb->query($sql); 
		
		$sql = "UPDATE ".MM_TABLE_QUEUE."  set status='".self::MM_STATUS_PENDING."' where pipeline='{$pipeline}' and status='".self::MM_STATUS_QUEUED."' ";
		$wpdb->query($sql); 
	}


    public static function changeStatus($id, $status="1")
    {
		global $wpdb;
		
		$sql = "UPDATE ".MM_TABLE_QUEUE." set status='".intval($status)."' where id='{$id}' limit 1";
		$wpdb->query($sql); 
	}

    public static function getCount()
    {
		global $wpdb;
		
		$sql = "SELECT count(*) as total FROM ".MM_TABLE_QUEUE." ";
		$row = $wpdb->get_row($sql);
		return $row->total;

	}
	
	public static function hasOrphanedQueueItems($pipeline)
	{
		global $wpdb;
		
		$sql = "SELECT count(*) as total FROM ".MM_TABLE_QUEUE." where pipeline='{$pipeline}' and status = '".self::MM_STATUS_QUEUED."' ";
		$row = $wpdb->get_row($sql);
		return ($row->total>0);
	}

	public static function getAbandonedBatch($pipeline, $limit = 100)
	{
		global $wpdb;
		
		$sql = "SELECT * FROM ".MM_TABLE_QUEUE." where pipeline='{$pipeline}' and status='".self::MM_STATUS_QUEUED."' order by date_added asc limit {$limit}";
		$results = $wpdb->get_results($sql);
		if($results===false || (is_array($results) && count($results)<=0))
		{
			return false;
		}
		return $results;
	}

    public static function getBatch($pipeline, $limit = 100)
    {
		global $wpdb;
		
		$sql = "SELECT * FROM ".MM_TABLE_QUEUE." where pipeline='{$pipeline}' and status='".self::MM_STATUS_PENDING."' order by date_added asc limit {$limit}";
		$results = $wpdb->get_results($sql);
		if($results===false || (is_array($results) && count($results)<=0))
		{
			return false;
		}
		$ids=array();
		foreach($results as $row)
		{
			$ids[] = $row->id;
		}
		
		$sql = "update ".MM_TABLE_QUEUE." set status='".self::MM_STATUS_QUEUED."' where id IN (".implode(",", $ids).") ";
		$wpdb->query($sql);

		return $results;
    }

    public static function getNextQueueItem($pipeline)
    {
		global $wpdb;
		
		$sql = "SELECT `data` as queue_item FROM ".MM_TABLE_QUEUE." where pipeline='{$pipeline}' order by date_added asc limit 1";
		$row = $wpdb->get_row($sql);
		if($row===false)
		{
			return false;
		}
		return $row->queue_item;
    }
    
    public function remove()
    {
        global $db;
        $db->query("delete from ".MM_TABLE_QUEUE." where id='{$this->id}' limit 1");
    }
	
	public static function removeByPipeline($key) 
	{
		global $wpdb;
		
		$sql = "DELETE FROM ".MM_TABLE_QUEUE." WHERE pipeline='".$key."'";
		$ret = $wpdb->query($sql);
		
		return ($ret!==false);
	}  
	
	public function setData($data)
	{
		try 
		{
			$this->pipeline = $data->pipeline;
			$this->data = $data->data;
			$this->status = $data->status;
			$this->dateAdded = $data->date_added;
			parent::validate();
		}
		catch (Exception $ex) 
		{
			parent::invalidate();
		}
	}
	
	public function commitData()
	{	
		global $wpdb;
		if(intval($this->id)>0){
			$sql = "update ".MM_TABLE_QUEUE." set 
						message='%s', 
						status='%s', 
						data='%s' 
					where 
						id='{$this->id}'
			";
			$wpdb->query($wpdb->prepare($sql, $this->pipeline, $this->status, $this->data));
		}
		else{
			$sql = "insert into ".MM_TABLE_QUEUE." set 
			pipeline='%s', 
			status='%s', 
					data='%s' 
			";
			$wpdb->query($wpdb->prepare($sql, $this->pipeline, $this->status, $this->data));
		}
	}
	
	public function setStatus($status){
		$this->status = $status;
	}
	
	public function getStatus(){
		return $this->status;
	}
	
	public function setPipeline($pipeline){
		$this->pipeline = $pipeline;
	}
	
	public function getPipeline(){
		return $this->pipeline;
	}
	
	public function setQueueData($myData){
		$this->data = serialize($myData);
	}
	
	public function getQueueData(){
		return unserialize($this->data);
	} 
	
	public function getDateAdded(){
		return $this->dateAdded;
	}
}